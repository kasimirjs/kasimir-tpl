/**
 * Infracamp's Kasimir Templates
 *
 * A no-dependency render on request
 *
 * @author Matthias Leuffen <m@tth.es>
 */

class KT_Renderable extends HTMLElement
{
    constructor() {
        super();

        this.state = {
            parentTpls: []
        };
    }


    cloneNode(deep) {
        let state = this.state;
        let x = super.cloneNode(deep);
        x.state = state;
        return x;
    }

    dump() {
        let ret = {sub: [], elem: this};
        for (let cur of this.state.parentTpls)
            ret.sub.push(cur.dump());
        return ret;
    }

    render(scope) {
        for(let i = 0; i < this.state.parentTpls.length; i++) {
            this.state.parentTpls[i].render(scope);
        }
    }

}


class KT_Template extends KT_Renderable
{
    constructor() {
        super();
        this.isRendered = false;
    }

    render(scope) {
        if (this.isRendered === false) {
            this.appendChild(this.state.origNode.cloneNode(true));
            this.isRendered = true;
        }

        for(let i = 0; i < this.state.parentTpls.length; i++) {
            this.state.parentTpls[i].render(scope);
        }
        console.log("Dump from tpl: ", this.dump());
    }

    /**
     *
     * @param targetNode
     * @return {KT_Template}
     */
    mount(targetNode) {


        return this;
    }

}

customElements.define("x-kt-template", KT_Template);

class KT_ForDirective extends KT_Renderable {

    constructor() {
        super();
    }

    static applies(node) {
        return node.hasAttribute("ngFor");
    }

    /**
     *
     * @param {this} instane
     * @param {HTMLElement} node
     */
    static apply (instane, node) {
        let stmt = node.getAttribute("ngFor");



        console.log(result);

    }

    render(scope) {
        let result = new RegExp("let (\\w+) of ([a-zA-Z0-9_.]+)");
        result = result.exec(this.state.ngFor);

        let selector = result[2];
        let target = result[1];

        let val = scope[selector];

        console.log(scope, val);

        // Create new elements
        for (let i = this.state.parentTpls.length; i < val.length; i++) {
            let e = this.state.origNode.cloneNode(true);
            // this.ownerDocument.adoptNode(e);
            this.state.parentTpls.push(e);


            console.log("append", e, "to", this.outerHTML);
            this.append(e);

        }

        for (let i = 0; i < val.length; i++) {
            console.log ("Refresh", i, `with scope[${target}] = '${val[i]}'`);
            scope[target] = val[i];
            scope["idx"] = i;
            this.state.parentTpls[i].render(scope);
        }


        //for (let i = this.state.parentTpls.length; i > val.length; i--) {
        //    let c = this.state.parentTpls.pop();
        //    this.removeChild(c);
        //}

    }

}

customElements.define("x-kt-for-directive", KT_ForDirective);
class KT_ForElement extends KT_Renderable {

    constructor() {
        super();
        console.log("Forelement construct")
        this.isRendered = false;
    }

    render(scope) {
        //if (! this.isRendered) {

            this.appendChild(this.state.origNode.cloneNode(true));
            this.isRendered = true;
        //}
        super.render(scope);
        console.log("Render forelement", this.outerHTML, "in scope", scope)
    }

}

customElements.define("x-kt-for-element", KT_ForElement);


class Renderer {

    constructor() {
        /**
         *
         * @type {KT_ForDirective[]}
         */
        this.directives = [
            KT_ForDirective
        ]
    }


    /**
     *
     * @param {HTMLDivElement} node
     * @param {KT_Renderable} curTplElem
     * @private
     */
    _parse(node, curTplElem) {
        let tpl = null;
        let nodeOrig = null;
        console.log("run", node);


        if (node.hasAttribute("ngFor")) {
            nodeOrig = node;
            node = node.cloneNode(true);

            tpl = new KT_ForDirective();
            tpl.state.ngFor = node.getAttribute("ngFor");

            let elem = new KT_ForElement();
            //elem.appendChild(node);
            elem.state.origNode = node;

            tpl.state.origNode = elem;

            curTplElem.state.parentTpls.push(tpl);
            curTplElem = elem;
        }


        for (let i=0; i < node.children.length; i++) {
            this._parse(node.children.item(i), curTplElem);
        }
        if (tpl === null) {

        } else {
            nodeOrig.replaceWith(tpl);

        }
    }

    /**
     *
     * @param templateNode
     * @return {KT_Template}
     */
    getTemplate(templateNode) {
        let tpl = new KT_Template();

        if (templateNode instanceof HTMLTemplateElement) {
            let mainNode = templateNode.content.children.item(0);
            console.log("Template start", mainNode);

            templateNode.parentElement.ownerDocument.adoptNode(mainNode);

            tpl.state.origNode = mainNode.cloneNode(true);
            templateNode.parentElement.appendChild(tpl);
            this._parse(mainNode, tpl);

        } else {
            tpl.state.origNode = templateNode;
            this._parse(templateNode, tpl);
        }

        return tpl;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUva3QtcmVuZGVyYWJsZS5qcyIsImNvcmUva3QtdGVtcGxhdGUuanMiLCJmb3ItZGlyZWN0aXZlLmpzIiwiZm9yLWVsZW1lbnQuanMiLCJyZW5kZXJlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDakNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6Imthc2ltaXItdHBsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5jbGFzcyBLVF9SZW5kZXJhYmxlIGV4dGVuZHMgSFRNTEVsZW1lbnRcbntcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgcGFyZW50VHBsczogW11cbiAgICAgICAgfTtcbiAgICB9XG5cblxuICAgIGNsb25lTm9kZShkZWVwKSB7XG4gICAgICAgIGxldCBzdGF0ZSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGxldCB4ID0gc3VwZXIuY2xvbmVOb2RlKGRlZXApO1xuICAgICAgICB4LnN0YXRlID0gc3RhdGU7XG4gICAgICAgIHJldHVybiB4O1xuICAgIH1cblxuICAgIGR1bXAoKSB7XG4gICAgICAgIGxldCByZXQgPSB7c3ViOiBbXSwgZWxlbTogdGhpc307XG4gICAgICAgIGZvciAobGV0IGN1ciBvZiB0aGlzLnN0YXRlLnBhcmVudFRwbHMpXG4gICAgICAgICAgICByZXQuc3ViLnB1c2goY3VyLmR1bXAoKSk7XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuXG4gICAgcmVuZGVyKHNjb3BlKSB7XG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLnN0YXRlLnBhcmVudFRwbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUucGFyZW50VHBsc1tpXS5yZW5kZXIoc2NvcGUpO1xuICAgICAgICB9XG4gICAgfVxuXG59XG5cbiIsImNsYXNzIEtUX1RlbXBsYXRlIGV4dGVuZHMgS1RfUmVuZGVyYWJsZVxue1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLmlzUmVuZGVyZWQgPSBmYWxzZTtcbiAgICB9XG5cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNSZW5kZXJlZCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGhpcy5zdGF0ZS5vcmlnTm9kZS5jbG9uZU5vZGUodHJ1ZSkpO1xuICAgICAgICAgICAgdGhpcy5pc1JlbmRlcmVkID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLnN0YXRlLnBhcmVudFRwbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUucGFyZW50VHBsc1tpXS5yZW5kZXIoc2NvcGUpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFwiRHVtcCBmcm9tIHRwbDogXCIsIHRoaXMuZHVtcCgpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB0YXJnZXROb2RlXG4gICAgICogQHJldHVybiB7S1RfVGVtcGxhdGV9XG4gICAgICovXG4gICAgbW91bnQodGFyZ2V0Tm9kZSkge1xuXG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG59XG5cbmN1c3RvbUVsZW1lbnRzLmRlZmluZShcIngta3QtdGVtcGxhdGVcIiwgS1RfVGVtcGxhdGUpO1xuIiwiY2xhc3MgS1RfRm9yRGlyZWN0aXZlIGV4dGVuZHMgS1RfUmVuZGVyYWJsZSB7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXBwbGllcyhub2RlKSB7XG4gICAgICAgIHJldHVybiBub2RlLmhhc0F0dHJpYnV0ZShcIm5nRm9yXCIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHt0aGlzfSBpbnN0YW5lXG4gICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gbm9kZVxuICAgICAqL1xuICAgIHN0YXRpYyBhcHBseSAoaW5zdGFuZSwgbm9kZSkge1xuICAgICAgICBsZXQgc3RtdCA9IG5vZGUuZ2V0QXR0cmlidXRlKFwibmdGb3JcIik7XG5cblxuXG4gICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdCk7XG5cbiAgICB9XG5cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IG5ldyBSZWdFeHAoXCJsZXQgKFxcXFx3Kykgb2YgKFthLXpBLVowLTlfLl0rKVwiKTtcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmV4ZWModGhpcy5zdGF0ZS5uZ0Zvcik7XG5cbiAgICAgICAgbGV0IHNlbGVjdG9yID0gcmVzdWx0WzJdO1xuICAgICAgICBsZXQgdGFyZ2V0ID0gcmVzdWx0WzFdO1xuXG4gICAgICAgIGxldCB2YWwgPSBzY29wZVtzZWxlY3Rvcl07XG5cbiAgICAgICAgY29uc29sZS5sb2coc2NvcGUsIHZhbCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIG5ldyBlbGVtZW50c1xuICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5zdGF0ZS5wYXJlbnRUcGxzLmxlbmd0aDsgaSA8IHZhbC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbGV0IGUgPSB0aGlzLnN0YXRlLm9yaWdOb2RlLmNsb25lTm9kZSh0cnVlKTtcbiAgICAgICAgICAgIC8vIHRoaXMub3duZXJEb2N1bWVudC5hZG9wdE5vZGUoZSk7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnBhcmVudFRwbHMucHVzaChlKTtcblxuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImFwcGVuZFwiLCBlLCBcInRvXCIsIHRoaXMub3V0ZXJIVE1MKTtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kKGUpO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc29sZS5sb2cgKFwiUmVmcmVzaFwiLCBpLCBgd2l0aCBzY29wZVske3RhcmdldH1dID0gJyR7dmFsW2ldfSdgKTtcbiAgICAgICAgICAgIHNjb3BlW3RhcmdldF0gPSB2YWxbaV07XG4gICAgICAgICAgICBzY29wZVtcImlkeFwiXSA9IGk7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnBhcmVudFRwbHNbaV0ucmVuZGVyKHNjb3BlKTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgLy9mb3IgKGxldCBpID0gdGhpcy5zdGF0ZS5wYXJlbnRUcGxzLmxlbmd0aDsgaSA+IHZhbC5sZW5ndGg7IGktLSkge1xuICAgICAgICAvLyAgICBsZXQgYyA9IHRoaXMuc3RhdGUucGFyZW50VHBscy5wb3AoKTtcbiAgICAgICAgLy8gICAgdGhpcy5yZW1vdmVDaGlsZChjKTtcbiAgICAgICAgLy99XG5cbiAgICB9XG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC1mb3ItZGlyZWN0aXZlXCIsIEtUX0ZvckRpcmVjdGl2ZSk7IiwiY2xhc3MgS1RfRm9yRWxlbWVudCBleHRlbmRzIEtUX1JlbmRlcmFibGUge1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiRm9yZWxlbWVudCBjb25zdHJ1Y3RcIilcbiAgICAgICAgdGhpcy5pc1JlbmRlcmVkID0gZmFsc2U7XG4gICAgfVxuXG4gICAgcmVuZGVyKHNjb3BlKSB7XG4gICAgICAgIC8vaWYgKCEgdGhpcy5pc1JlbmRlcmVkKSB7XG5cbiAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGhpcy5zdGF0ZS5vcmlnTm9kZS5jbG9uZU5vZGUodHJ1ZSkpO1xuICAgICAgICAgICAgdGhpcy5pc1JlbmRlcmVkID0gdHJ1ZTtcbiAgICAgICAgLy99XG4gICAgICAgIHN1cGVyLnJlbmRlcihzY29wZSk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiUmVuZGVyIGZvcmVsZW1lbnRcIiwgdGhpcy5vdXRlckhUTUwsIFwiaW4gc2NvcGVcIiwgc2NvcGUpXG4gICAgfVxuXG59XG5cbmN1c3RvbUVsZW1lbnRzLmRlZmluZShcIngta3QtZm9yLWVsZW1lbnRcIiwgS1RfRm9yRWxlbWVudCk7IiwiXG5cbmNsYXNzIFJlbmRlcmVyIHtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICpcbiAgICAgICAgICogQHR5cGUge0tUX0ZvckRpcmVjdGl2ZVtdfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5kaXJlY3RpdmVzID0gW1xuICAgICAgICAgICAgS1RfRm9yRGlyZWN0aXZlXG4gICAgICAgIF1cbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHtIVE1MRGl2RWxlbWVudH0gbm9kZVxuICAgICAqIEBwYXJhbSB7S1RfUmVuZGVyYWJsZX0gY3VyVHBsRWxlbVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgX3BhcnNlKG5vZGUsIGN1clRwbEVsZW0pIHtcbiAgICAgICAgbGV0IHRwbCA9IG51bGw7XG4gICAgICAgIGxldCBub2RlT3JpZyA9IG51bGw7XG4gICAgICAgIGNvbnNvbGUubG9nKFwicnVuXCIsIG5vZGUpO1xuXG5cbiAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKFwibmdGb3JcIikpIHtcbiAgICAgICAgICAgIG5vZGVPcmlnID0gbm9kZTtcbiAgICAgICAgICAgIG5vZGUgPSBub2RlLmNsb25lTm9kZSh0cnVlKTtcblxuICAgICAgICAgICAgdHBsID0gbmV3IEtUX0ZvckRpcmVjdGl2ZSgpO1xuICAgICAgICAgICAgdHBsLnN0YXRlLm5nRm9yID0gbm9kZS5nZXRBdHRyaWJ1dGUoXCJuZ0ZvclwiKTtcblxuICAgICAgICAgICAgbGV0IGVsZW0gPSBuZXcgS1RfRm9yRWxlbWVudCgpO1xuICAgICAgICAgICAgLy9lbGVtLmFwcGVuZENoaWxkKG5vZGUpO1xuICAgICAgICAgICAgZWxlbS5zdGF0ZS5vcmlnTm9kZSA9IG5vZGU7XG5cbiAgICAgICAgICAgIHRwbC5zdGF0ZS5vcmlnTm9kZSA9IGVsZW07XG5cbiAgICAgICAgICAgIGN1clRwbEVsZW0uc3RhdGUucGFyZW50VHBscy5wdXNoKHRwbCk7XG4gICAgICAgICAgICBjdXJUcGxFbGVtID0gZWxlbTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgZm9yIChsZXQgaT0wOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5fcGFyc2Uobm9kZS5jaGlsZHJlbi5pdGVtKGkpLCBjdXJUcGxFbGVtKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHBsID09PSBudWxsKSB7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5vZGVPcmlnLnJlcGxhY2VXaXRoKHRwbCk7XG5cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHRlbXBsYXRlTm9kZVxuICAgICAqIEByZXR1cm4ge0tUX1RlbXBsYXRlfVxuICAgICAqL1xuICAgIGdldFRlbXBsYXRlKHRlbXBsYXRlTm9kZSkge1xuICAgICAgICBsZXQgdHBsID0gbmV3IEtUX1RlbXBsYXRlKCk7XG5cbiAgICAgICAgaWYgKHRlbXBsYXRlTm9kZSBpbnN0YW5jZW9mIEhUTUxUZW1wbGF0ZUVsZW1lbnQpIHtcbiAgICAgICAgICAgIGxldCBtYWluTm9kZSA9IHRlbXBsYXRlTm9kZS5jb250ZW50LmNoaWxkcmVuLml0ZW0oMCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRlbXBsYXRlIHN0YXJ0XCIsIG1haW5Ob2RlKTtcblxuICAgICAgICAgICAgdGVtcGxhdGVOb2RlLnBhcmVudEVsZW1lbnQub3duZXJEb2N1bWVudC5hZG9wdE5vZGUobWFpbk5vZGUpO1xuXG4gICAgICAgICAgICB0cGwuc3RhdGUub3JpZ05vZGUgPSBtYWluTm9kZS5jbG9uZU5vZGUodHJ1ZSk7XG4gICAgICAgICAgICB0ZW1wbGF0ZU5vZGUucGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZCh0cGwpO1xuICAgICAgICAgICAgdGhpcy5fcGFyc2UobWFpbk5vZGUsIHRwbCk7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRwbC5zdGF0ZS5vcmlnTm9kZSA9IHRlbXBsYXRlTm9kZTtcbiAgICAgICAgICAgIHRoaXMuX3BhcnNlKHRlbXBsYXRlTm9kZSwgdHBsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cGw7XG4gICAgfVxufSJdfQ==
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUva3QtcmVuZGVyYWJsZS5qcyIsImNvcmUva3QtdGVtcGxhdGUuanMiLCJmb3ItZGlyZWN0aXZlLmpzIiwiZm9yLWVsZW1lbnQuanMiLCJyZW5kZXJlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbENBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDakNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNoRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6Imthc2ltaXItdHBsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5jbGFzcyBLVF9SZW5kZXJhYmxlIGV4dGVuZHMgSFRNTEVsZW1lbnRcbntcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgcGFyZW50VHBsczogW11cbiAgICAgICAgfTtcbiAgICB9XG5cblxuICAgIGNsb25lTm9kZShkZWVwKSB7XG4gICAgICAgIGxldCBzdGF0ZSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGxldCB4ID0gc3VwZXIuY2xvbmVOb2RlKGRlZXApO1xuICAgICAgICB4LnN0YXRlID0gc3RhdGU7XG4gICAgICAgIHJldHVybiB4O1xuICAgIH1cblxuICAgIGR1bXAoKSB7XG4gICAgICAgIGxldCByZXQgPSB7c3ViOiBbXSwgZWxlbTogdGhpc307XG4gICAgICAgIGZvciAobGV0IGN1ciBvZiB0aGlzLnN0YXRlLnBhcmVudFRwbHMpXG4gICAgICAgICAgICByZXQuc3ViLnB1c2goY3VyLmR1bXAoKSk7XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuXG4gICAgcmVuZGVyKHNjb3BlKSB7XG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLnN0YXRlLnBhcmVudFRwbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUucGFyZW50VHBsc1tpXS5yZW5kZXIoc2NvcGUpO1xuICAgICAgICB9XG4gICAgfVxuXG59XG5cbiIsImNsYXNzIEtUX1RlbXBsYXRlIGV4dGVuZHMgS1RfUmVuZGVyYWJsZVxue1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLmlzUmVuZGVyZWQgPSBmYWxzZTtcbiAgICB9XG5cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNSZW5kZXJlZCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGhpcy5zdGF0ZS5vcmlnTm9kZS5jbG9uZU5vZGUodHJ1ZSkpO1xuICAgICAgICAgICAgdGhpcy5pc1JlbmRlcmVkID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLnN0YXRlLnBhcmVudFRwbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUucGFyZW50VHBsc1tpXS5yZW5kZXIoc2NvcGUpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFwiRHVtcCBmcm9tIHRwbDogXCIsIHRoaXMuZHVtcCgpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB0YXJnZXROb2RlXG4gICAgICogQHJldHVybiB7S1RfVGVtcGxhdGV9XG4gICAgICovXG4gICAgbW91bnQodGFyZ2V0Tm9kZSkge1xuXG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG59XG5cbmN1c3RvbUVsZW1lbnRzLmRlZmluZShcIngta3QtdGVtcGxhdGVcIiwgS1RfVGVtcGxhdGUpO1xuIiwiY2xhc3MgS1RfRm9yRGlyZWN0aXZlIGV4dGVuZHMgS1RfUmVuZGVyYWJsZSB7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXBwbGllcyhub2RlKSB7XG4gICAgICAgIHJldHVybiBub2RlLmhhc0F0dHJpYnV0ZShcIm5nRm9yXCIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHt0aGlzfSBpbnN0YW5lXG4gICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gbm9kZVxuICAgICAqL1xuICAgIHN0YXRpYyBhcHBseSAoaW5zdGFuZSwgbm9kZSkge1xuICAgICAgICBsZXQgc3RtdCA9IG5vZGUuZ2V0QXR0cmlidXRlKFwibmdGb3JcIik7XG5cblxuXG4gICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdCk7XG5cbiAgICB9XG5cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IG5ldyBSZWdFeHAoXCJsZXQgKFxcXFx3Kykgb2YgKFthLXpBLVowLTlfLl0rKVwiKTtcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmV4ZWModGhpcy5zdGF0ZS5uZ0Zvcik7XG5cbiAgICAgICAgbGV0IHNlbGVjdG9yID0gcmVzdWx0WzJdO1xuICAgICAgICBsZXQgdGFyZ2V0ID0gcmVzdWx0WzFdO1xuXG4gICAgICAgIGxldCB2YWwgPSBzY29wZVtzZWxlY3Rvcl07XG5cbiAgICAgICAgY29uc29sZS5sb2coc2NvcGUsIHZhbCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIG5ldyBlbGVtZW50c1xuICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5zdGF0ZS5wYXJlbnRUcGxzLmxlbmd0aDsgaSA8IHZhbC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbGV0IGUgPSB0aGlzLnN0YXRlLm9yaWdOb2RlLmNsb25lTm9kZSh0cnVlKTtcbiAgICAgICAgICAgIC8vIHRoaXMub3duZXJEb2N1bWVudC5hZG9wdE5vZGUoZSk7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnBhcmVudFRwbHMucHVzaChlKTtcblxuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImFwcGVuZFwiLCBlLCBcInRvXCIsIHRoaXMub3V0ZXJIVE1MKTtcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kKGUpO1xuXG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgY29uc29sZS5sb2cgKFwiUmVmcmVzaFwiLCBpLCBgd2l0aCBzY29wZVske3RhcmdldH1dID0gJyR7dmFsW2ldfSdgKTtcbiAgICAgICAgICAgIHNjb3BlW3RhcmdldF0gPSB2YWxbaV07XG4gICAgICAgICAgICBzY29wZVtcImlkeFwiXSA9IGk7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnBhcmVudFRwbHNbaV0ucmVuZGVyKHNjb3BlKTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgLy9mb3IgKGxldCBpID0gdGhpcy5zdGF0ZS5wYXJlbnRUcGxzLmxlbmd0aDsgaSA+IHZhbC5sZW5ndGg7IGktLSkge1xuICAgICAgICAvLyAgICBsZXQgYyA9IHRoaXMuc3RhdGUucGFyZW50VHBscy5wb3AoKTtcbiAgICAgICAgLy8gICAgdGhpcy5yZW1vdmVDaGlsZChjKTtcbiAgICAgICAgLy99XG5cbiAgICB9XG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC1mb3ItZGlyZWN0aXZlXCIsIEtUX0ZvckRpcmVjdGl2ZSk7IiwiY2xhc3MgS1RfRm9yRWxlbWVudCBleHRlbmRzIEtUX1JlbmRlcmFibGUge1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiRm9yZWxlbWVudCBjb25zdHJ1Y3RcIilcbiAgICAgICAgdGhpcy5pc1JlbmRlcmVkID0gZmFsc2U7XG4gICAgfVxuXG4gICAgcmVuZGVyKHNjb3BlKSB7XG4gICAgICAgIC8vaWYgKCEgdGhpcy5pc1JlbmRlcmVkKSB7XG5cbiAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGhpcy5zdGF0ZS5vcmlnTm9kZS5jbG9uZU5vZGUodHJ1ZSkpO1xuICAgICAgICAgICAgdGhpcy5pc1JlbmRlcmVkID0gdHJ1ZTtcbiAgICAgICAgLy99XG4gICAgICAgIHN1cGVyLnJlbmRlcihzY29wZSk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiUmVuZGVyIGZvcmVsZW1lbnRcIiwgdGhpcy5vdXRlckhUTUwsIFwiaW4gc2NvcGVcIiwgc2NvcGUpXG4gICAgfVxuXG59XG5cbmN1c3RvbUVsZW1lbnRzLmRlZmluZShcIngta3QtZm9yLWVsZW1lbnRcIiwgS1RfRm9yRWxlbWVudCk7IiwiXG5cbmNsYXNzIFJlbmRlcmVyIHtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICAvKipcbiAgICAgICAgICpcbiAgICAgICAgICogQHR5cGUge0tUX0ZvckRpcmVjdGl2ZVtdfVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5kaXJlY3RpdmVzID0gW1xuICAgICAgICAgICAgS1RfRm9yRGlyZWN0aXZlXG4gICAgICAgIF1cbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHtIVE1MRGl2RWxlbWVudH0gbm9kZVxuICAgICAqIEBwYXJhbSB7S1RfUmVuZGVyYWJsZX0gY3VyVHBsRWxlbVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgX3BhcnNlKG5vZGUsIGN1clRwbEVsZW0pIHtcbiAgICAgICAgbGV0IHRwbCA9IG51bGw7XG4gICAgICAgIGxldCBub2RlT3JpZyA9IG51bGw7XG4gICAgICAgIGNvbnNvbGUubG9nKFwicnVuXCIsIG5vZGUpO1xuXG5cbiAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKFwibmdGb3JcIikpIHtcbiAgICAgICAgICAgIG5vZGVPcmlnID0gbm9kZTtcbiAgICAgICAgICAgIG5vZGUgPSBub2RlLmNsb25lTm9kZSh0cnVlKTtcblxuICAgICAgICAgICAgdHBsID0gbmV3IEtUX0ZvckRpcmVjdGl2ZSgpO1xuICAgICAgICAgICAgdHBsLnN0YXRlLm5nRm9yID0gbm9kZS5nZXRBdHRyaWJ1dGUoXCJuZ0ZvclwiKTtcblxuICAgICAgICAgICAgbGV0IGVsZW0gPSBuZXcgS1RfRm9yRWxlbWVudCgpO1xuICAgICAgICAgICAgLy9lbGVtLmFwcGVuZENoaWxkKG5vZGUpO1xuICAgICAgICAgICAgZWxlbS5zdGF0ZS5vcmlnTm9kZSA9IG5vZGU7XG5cbiAgICAgICAgICAgIHRwbC5zdGF0ZS5vcmlnTm9kZSA9IGVsZW07XG5cbiAgICAgICAgICAgIGN1clRwbEVsZW0uc3RhdGUucGFyZW50VHBscy5wdXNoKHRwbCk7XG4gICAgICAgICAgICBjdXJUcGxFbGVtID0gZWxlbTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgZm9yIChsZXQgaT0wOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5fcGFyc2Uobm9kZS5jaGlsZHJlbi5pdGVtKGkpLCBjdXJUcGxFbGVtKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHBsID09PSBudWxsKSB7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5vZGVPcmlnLnJlcGxhY2VXaXRoKHRwbCk7XG5cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHRlbXBsYXRlTm9kZVxuICAgICAqIEByZXR1cm4ge0tUX1RlbXBsYXRlfVxuICAgICAqL1xuICAgIGdldFRlbXBsYXRlKHRlbXBsYXRlTm9kZSkge1xuICAgICAgICBsZXQgdHBsID0gbmV3IEtUX1RlbXBsYXRlKCk7XG5cbiAgICAgICAgaWYgKHRlbXBsYXRlTm9kZSBpbnN0YW5jZW9mIEhUTUxUZW1wbGF0ZUVsZW1lbnQpIHtcbiAgICAgICAgICAgIGxldCBtYWluTm9kZSA9IHRlbXBsYXRlTm9kZS5jb250ZW50LmNoaWxkcmVuLml0ZW0oMCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRlbXBsYXRlIHN0YXJ0XCIsIG1haW5Ob2RlKTtcblxuICAgICAgICAgICAgdGVtcGxhdGVOb2RlLnBhcmVudEVsZW1lbnQub3duZXJEb2N1bWVudC5hZG9wdE5vZGUobWFpbk5vZGUpO1xuXG4gICAgICAgICAgICB0cGwuc3RhdGUub3JpZ05vZGUgPSBtYWluTm9kZS5jbG9uZU5vZGUodHJ1ZSk7XG4gICAgICAgICAgICB0ZW1wbGF0ZU5vZGUucGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZCh0cGwpO1xuICAgICAgICAgICAgdGhpcy5fcGFyc2UobWFpbk5vZGUsIHRwbCk7XG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRwbC5zdGF0ZS5vcmlnTm9kZSA9IHRlbXBsYXRlTm9kZTtcbiAgICAgICAgICAgIHRoaXMuX3BhcnNlKHRlbXBsYXRlTm9kZSwgdHBsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cGw7XG4gICAgfVxufSJdfQ==
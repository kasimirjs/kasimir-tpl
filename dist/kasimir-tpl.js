/**
 * Infracamp's Kasimir Templates
 *
 * A no-dependency render on request
 *
 * @author Matthias Leuffen <m@tth.es>
 */

class KT_Renderable extends HTMLElement
{
    constructor() {
        super();
        this.state = {
            origNode: null
        };

    }

    /**
     *
     * @param {HTMLElement} node
     * @param scope
     */
    renderRecursive(node, scope){
        if ( ! node.hasChildNodes())
            return;
        // console.log("renderRecursive", node);
        for (let curNode of node.childNodes) {

            if (typeof curNode.render === "function") {
                console.log("render", curNode);
                curNode.render(scope);
                continue;
            }
            this.renderRecursive(curNode, scope);
        }
    }


    initRecursive(node) {
        if (typeof node === "undefined")
            node = this;

        if (typeof node.onKtInit === "function")
            node.onKtInit();

        for (let curNode of node.childNodes) {

            this.initRecursive(curNode);
        }

        if (typeof node.onAfterKtInit === "function")
            node.onAfterKtInit();
    }
}

var KT_FN = {
    /**
     *
     * @param {HTMLElement} elem
     * @param {string} val
     * @param scope
     */
    "[class]": function(elem, val, scope) {
        "use strict";
        try {
            var classes = null;
            let e = "classes = " + val;
            let ret = eval(e);
            console.log("eval", e, "ret: ", ret, "classes:", classes);
        } catch (e) {
            throw e + " in [data] of " + elem.outerHTML;
        }
        for (let className in classes) {
            if ( ! classes.hasOwnProperty(className))
                continue;
            if (classes[className] === true) {
                elem.classList.add(className);
            } else {
                elem.classList.remove(className);
            }
        }
    }
};
var KT_DATA = [];


class KT_Template extends KT_Renderable
{
    constructor() {
        super();
        this.isRendered = false;
    }

    render(scope) {
        if (this.isRendered === false) {
            this.appendChild(this.state.origNode.cloneNode(true));
            this.isRendered = true;
        }

        for(let i = 0; i < this.state.parentTpls.length; i++) {
            this.state.parentTpls[i].render(scope);
        }
        console.log("Dump from tpl: ", this.dump());
    }

    /**
     *
     * @param targetNode
     * @return {KT_Template}
     */
    mount(targetNode) {


        return this;
    }

}

customElements.define("x-kt-template", KT_Template);

class KT_ForDirective extends KT_Renderable {

    constructor() {
        super();
        // console.log("construct", this.outerHTML);
        this.state.len = 0;
    }


    onKtInit() {

    }

    onAfterKtInit() {
        console.log("onKtInit()", this.outerHTML)
        let ktBlock = this.firstElementChild;

        if ( ! ktBlock instanceof KtBlock || typeof ktBlock !== "object") {
            console.error("Element child of x-kt-for must be x-kt-block in", this.outerHTML)
            throw "Element chilf of x-kt-for must be x-kt-block."
        }

        if ( ! this.hasAttribute("kt-id")) {
            this.setAttribute("kt-id", KT_DATA.length)
        }
        KT_DATA.push({origNode: ktBlock});

        for(let i = 0; i < this.children.length; i++)
            this.removeChild(this.children.item(0));
    }

    connectedCallback() {
    }

    disconnectedCallback() {
        console.log("disconnected", this.outerHTML);
    }

    render(scope) {
        let ktId = parseInt(this.getAttribute("kt-id"));
        let result = new RegExp("let (\\w+) of ([a-zA-Z0-9_.]+)");
        result = result.exec(this.getAttribute("for"));

        let selector = result[2];
        let target = result[1];

        let val = scope[selector];

        //console.log("render() scope: ", scope, "value:", val);

        // Create new elements
        for (let i = this.state.len; i < val.length; i++) {
            //console.log("append",  "to", this.outerHTML, this.state);
            let e = KT_DATA[ktId].origNode.cloneNode(true);
            // this.ownerDocument.adoptNode(e);

            this.append(e);
            this.state.len++;
        }


        for (let i = 0; i < val.length; i++) {
            //console.log ("Refresh", i, `with scope[${target}] = '${val[i]}'`);
            scope[target] = val[i];
            scope["idx"] = i;
            let curNode = this.children.item(i);
            //console.log ("node is", curNode, this.children);
            curNode.render(scope);
        }


        for (let i = this.state.len; i > val.length; i--) {
            //    let c = this.state.parentTpls.pop();
            this.removeChild(this.lastElementChild);
            this.state.len--;
        }

    }

}

customElements.define("x-kt-for", KT_ForDirective);
class KtBlock extends KT_Renderable {

    constructor() {
        super();
        this.state.elements = [];
    }

    conntectedCallback() {

    }

    /*
    onKtInit() {
        this.state.ele
    }
*/

    /**
     *
     * @param {HTMLElement} elem
     * @param scope
     */
    applyLogic(elem, scope) {
        for(let attribName of elem.getAttributeNames()) {
            if (typeof KT_FN[attribName] === "undefined")
                continue;
            let fn = KT_FN[attribName];
            fn(elem, elem.getAttribute(attribName), scope);
        }
    }


    render(scope) {
        "use strict";
        console.log("apply logic");
        for (let elem of this.children) {
            this.applyLogic(elem, scope);
            this.renderRecursive(elem, scope);
        }

    }



}

customElements.define("x-kt-block", KtBlock);


class KtIf extends KT_Renderable {

    onAfterKtInit() {
        console.log("onKtInit()", this.outerHTML)
        let ktBlock = this.firstElementChild;

        if ( ! ktBlock instanceof KtBlock || typeof ktBlock !== "object") {
            console.error("Element child of x-kt-for must be x-kt-block in", this.outerHTML)
            throw "Element chilf of x-kt-for must be x-kt-block."
        }

        if ( ! this.hasAttribute("kt-id")) {
            this.setAttribute("kt-id", KT_DATA.length)
        }
        KT_DATA.push({origNode: ktBlock});

        for(let i = 0; i < this.children.length; i++)
            this.removeChild(this.children.item(0));
    }


    render(scope) {
        let stmt = this.getAttribute("stmt");

        let show = eval(stmt);

        if (show) {
            if (this.children.length === 0)
                this.appendChild(KT_DATA[this.getAttribute("kt-id")].origNode.cloneNode(true));

            this.renderRecursive(this.children.item(0), scope);
        }

        if ( ! show && this.hasChildNodes()) {

            for(let i = 0; i < this.children.length; i++)
                this.renderRecursive(this.children.item(0));
        }

    }


}

customElements.define("x-kt-if", KtIf);



class KTVal extends HTMLElement {



    render(scope) {
        let select = this.getAttribute("select");
        this.innerText = scope[select];
    }


}

customElements.define("x-kt-val", KTVal);


class Renderer {

    constructor() {
        /**
         *
         * @type {KT_ForDirective[]}
         */
        this.directives = [
            KT_ForDirective
        ]
    }


    /**
     *
     * @param {HTMLDivElement} node
     * @param {KT_Renderable} curTplElem
     * @private
     */
    _parse(node, curTplElem) {
        let tpl = null;
        let nodeOrig = null;
        console.log("run", node);


        if (node.hasAttribute("ngFor")) {
            nodeOrig = node;
            node = node.cloneNode(true);

            tpl = new KT_ForDirective();
            tpl.state.ngFor = node.getAttribute("ngFor");

            let elem = new KT_ForElement();
            //elem.appendChild(node);
            elem.state.origNode = node;

            tpl.state.origNode = elem;

            curTplElem.state.parentTpls.push(tpl);
            curTplElem = elem;
        }


        for (let i=0; i < node.children.length; i++) {
            this._parse(node.children.item(i), curTplElem);
        }
        if (tpl === null) {

        } else {
            nodeOrig.replaceWith(tpl);

        }
    }

    /**
     *
     * @param templateNode
     * @return {KT_Template}
     */
    getTemplate(templateNode) {
        let tpl = new KT_Template();

        if (templateNode instanceof HTMLTemplateElement) {
            let mainNode = templateNode.content.children.item(0);
            console.log("Template start", mainNode);

            templateNode.parentElement.ownerDocument.adoptNode(mainNode);

            tpl.state.origNode = mainNode.cloneNode(true);
            templateNode.parentElement.appendChild(tpl);
            this._parse(mainNode, tpl);

        } else {
            tpl.state.origNode = templateNode;
            this._parse(templateNode, tpl);
        }

        return tpl;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUva3QtcmVuZGVyYWJsZS5qcyIsImNvcmUva3QtdGVtcGxhdGUuanMiLCJmb3ItZGlyZWN0aXZlLmpzIiwia3QtYmxvY2suanMiLCJrdC1pZi5qcyIsImt0LXZhbC5qcyIsInJlbmRlcmVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqRkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDZEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoia2FzaW1pci10cGwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmNsYXNzIEtUX1JlbmRlcmFibGUgZXh0ZW5kcyBIVE1MRWxlbWVudFxue1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgb3JpZ05vZGU6IG51bGxcbiAgICAgICAgfTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gbm9kZVxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqL1xuICAgIHJlbmRlclJlY3Vyc2l2ZShub2RlLCBzY29wZSl7XG4gICAgICAgIGlmICggISBub2RlLmhhc0NoaWxkTm9kZXMoKSlcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJyZW5kZXJSZWN1cnNpdmVcIiwgbm9kZSk7XG4gICAgICAgIGZvciAobGV0IGN1ck5vZGUgb2Ygbm9kZS5jaGlsZE5vZGVzKSB7XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgY3VyTm9kZS5yZW5kZXIgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicmVuZGVyXCIsIGN1ck5vZGUpO1xuICAgICAgICAgICAgICAgIGN1ck5vZGUucmVuZGVyKHNjb3BlKTtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucmVuZGVyUmVjdXJzaXZlKGN1ck5vZGUsIHNjb3BlKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgaW5pdFJlY3Vyc2l2ZShub2RlKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygbm9kZSA9PT0gXCJ1bmRlZmluZWRcIilcbiAgICAgICAgICAgIG5vZGUgPSB0aGlzO1xuXG4gICAgICAgIGlmICh0eXBlb2Ygbm9kZS5vbkt0SW5pdCA9PT0gXCJmdW5jdGlvblwiKVxuICAgICAgICAgICAgbm9kZS5vbkt0SW5pdCgpO1xuXG4gICAgICAgIGZvciAobGV0IGN1ck5vZGUgb2Ygbm9kZS5jaGlsZE5vZGVzKSB7XG5cbiAgICAgICAgICAgIHRoaXMuaW5pdFJlY3Vyc2l2ZShjdXJOb2RlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2Ygbm9kZS5vbkFmdGVyS3RJbml0ID09PSBcImZ1bmN0aW9uXCIpXG4gICAgICAgICAgICBub2RlLm9uQWZ0ZXJLdEluaXQoKTtcbiAgICB9XG59XG5cbnZhciBLVF9GTiA9IHtcbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGVsZW1cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsXG4gICAgICogQHBhcmFtIHNjb3BlXG4gICAgICovXG4gICAgXCJbY2xhc3NdXCI6IGZ1bmN0aW9uKGVsZW0sIHZhbCwgc2NvcGUpIHtcbiAgICAgICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB2YXIgY2xhc3NlcyA9IG51bGw7XG4gICAgICAgICAgICBsZXQgZSA9IFwiY2xhc3NlcyA9IFwiICsgdmFsO1xuICAgICAgICAgICAgbGV0IHJldCA9IGV2YWwoZSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImV2YWxcIiwgZSwgXCJyZXQ6IFwiLCByZXQsIFwiY2xhc3NlczpcIiwgY2xhc3Nlcyk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IGUgKyBcIiBpbiBbZGF0YV0gb2YgXCIgKyBlbGVtLm91dGVySFRNTDtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGxldCBjbGFzc05hbWUgaW4gY2xhc3Nlcykge1xuICAgICAgICAgICAgaWYgKCAhIGNsYXNzZXMuaGFzT3duUHJvcGVydHkoY2xhc3NOYW1lKSlcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIGlmIChjbGFzc2VzW2NsYXNzTmFtZV0gPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICBlbGVtLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZWxlbS5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xudmFyIEtUX0RBVEEgPSBbXTtcblxuIiwiY2xhc3MgS1RfVGVtcGxhdGUgZXh0ZW5kcyBLVF9SZW5kZXJhYmxlXG57XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuaXNSZW5kZXJlZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIHJlbmRlcihzY29wZSkge1xuICAgICAgICBpZiAodGhpcy5pc1JlbmRlcmVkID09PSBmYWxzZSkge1xuICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh0aGlzLnN0YXRlLm9yaWdOb2RlLmNsb25lTm9kZSh0cnVlKSk7XG4gICAgICAgICAgICB0aGlzLmlzUmVuZGVyZWQgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuc3RhdGUucGFyZW50VHBscy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5wYXJlbnRUcGxzW2ldLnJlbmRlcihzY29wZSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coXCJEdW1wIGZyb20gdHBsOiBcIiwgdGhpcy5kdW1wKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHRhcmdldE5vZGVcbiAgICAgKiBAcmV0dXJuIHtLVF9UZW1wbGF0ZX1cbiAgICAgKi9cbiAgICBtb3VudCh0YXJnZXROb2RlKSB7XG5cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC10ZW1wbGF0ZVwiLCBLVF9UZW1wbGF0ZSk7XG4iLCJjbGFzcyBLVF9Gb3JEaXJlY3RpdmUgZXh0ZW5kcyBLVF9SZW5kZXJhYmxlIHtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcImNvbnN0cnVjdFwiLCB0aGlzLm91dGVySFRNTCk7XG4gICAgICAgIHRoaXMuc3RhdGUubGVuID0gMDtcbiAgICB9XG5cblxuICAgIG9uS3RJbml0KCkge1xuXG4gICAgfVxuXG4gICAgb25BZnRlckt0SW5pdCgpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJvbkt0SW5pdCgpXCIsIHRoaXMub3V0ZXJIVE1MKVxuICAgICAgICBsZXQga3RCbG9jayA9IHRoaXMuZmlyc3RFbGVtZW50Q2hpbGQ7XG5cbiAgICAgICAgaWYgKCAhIGt0QmxvY2sgaW5zdGFuY2VvZiBLdEJsb2NrIHx8IHR5cGVvZiBrdEJsb2NrICE9PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRWxlbWVudCBjaGlsZCBvZiB4LWt0LWZvciBtdXN0IGJlIHgta3QtYmxvY2sgaW5cIiwgdGhpcy5vdXRlckhUTUwpXG4gICAgICAgICAgICB0aHJvdyBcIkVsZW1lbnQgY2hpbGYgb2YgeC1rdC1mb3IgbXVzdCBiZSB4LWt0LWJsb2NrLlwiXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoICEgdGhpcy5oYXNBdHRyaWJ1dGUoXCJrdC1pZFwiKSkge1xuICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoXCJrdC1pZFwiLCBLVF9EQVRBLmxlbmd0aClcbiAgICAgICAgfVxuICAgICAgICBLVF9EQVRBLnB1c2goe29yaWdOb2RlOiBrdEJsb2NrfSk7XG5cbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNoaWxkKHRoaXMuY2hpbGRyZW4uaXRlbSgwKSk7XG4gICAgfVxuXG4gICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgfVxuXG4gICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiZGlzY29ubmVjdGVkXCIsIHRoaXMub3V0ZXJIVE1MKTtcbiAgICB9XG5cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgbGV0IGt0SWQgPSBwYXJzZUludCh0aGlzLmdldEF0dHJpYnV0ZShcImt0LWlkXCIpKTtcbiAgICAgICAgbGV0IHJlc3VsdCA9IG5ldyBSZWdFeHAoXCJsZXQgKFxcXFx3Kykgb2YgKFthLXpBLVowLTlfLl0rKVwiKTtcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmV4ZWModGhpcy5nZXRBdHRyaWJ1dGUoXCJmb3JcIikpO1xuXG4gICAgICAgIGxldCBzZWxlY3RvciA9IHJlc3VsdFsyXTtcbiAgICAgICAgbGV0IHRhcmdldCA9IHJlc3VsdFsxXTtcblxuICAgICAgICBsZXQgdmFsID0gc2NvcGVbc2VsZWN0b3JdO1xuXG4gICAgICAgIC8vY29uc29sZS5sb2coXCJyZW5kZXIoKSBzY29wZTogXCIsIHNjb3BlLCBcInZhbHVlOlwiLCB2YWwpO1xuXG4gICAgICAgIC8vIENyZWF0ZSBuZXcgZWxlbWVudHNcbiAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc3RhdGUubGVuOyBpIDwgdmFsLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiYXBwZW5kXCIsICBcInRvXCIsIHRoaXMub3V0ZXJIVE1MLCB0aGlzLnN0YXRlKTtcbiAgICAgICAgICAgIGxldCBlID0gS1RfREFUQVtrdElkXS5vcmlnTm9kZS5jbG9uZU5vZGUodHJ1ZSk7XG4gICAgICAgICAgICAvLyB0aGlzLm93bmVyRG9jdW1lbnQuYWRvcHROb2RlKGUpO1xuXG4gICAgICAgICAgICB0aGlzLmFwcGVuZChlKTtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUubGVuKys7XG4gICAgICAgIH1cblxuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nIChcIlJlZnJlc2hcIiwgaSwgYHdpdGggc2NvcGVbJHt0YXJnZXR9XSA9ICcke3ZhbFtpXX0nYCk7XG4gICAgICAgICAgICBzY29wZVt0YXJnZXRdID0gdmFsW2ldO1xuICAgICAgICAgICAgc2NvcGVbXCJpZHhcIl0gPSBpO1xuICAgICAgICAgICAgbGV0IGN1ck5vZGUgPSB0aGlzLmNoaWxkcmVuLml0ZW0oaSk7XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nIChcIm5vZGUgaXNcIiwgY3VyTm9kZSwgdGhpcy5jaGlsZHJlbik7XG4gICAgICAgICAgICBjdXJOb2RlLnJlbmRlcihzY29wZSk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnN0YXRlLmxlbjsgaSA+IHZhbC5sZW5ndGg7IGktLSkge1xuICAgICAgICAgICAgLy8gICAgbGV0IGMgPSB0aGlzLnN0YXRlLnBhcmVudFRwbHMucG9wKCk7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNoaWxkKHRoaXMubGFzdEVsZW1lbnRDaGlsZCk7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLmxlbi0tO1xuICAgICAgICB9XG5cbiAgICB9XG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC1mb3JcIiwgS1RfRm9yRGlyZWN0aXZlKTsiLCJjbGFzcyBLdEJsb2NrIGV4dGVuZHMgS1RfUmVuZGVyYWJsZSB7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5lbGVtZW50cyA9IFtdO1xuICAgIH1cblxuICAgIGNvbm50ZWN0ZWRDYWxsYmFjaygpIHtcblxuICAgIH1cblxuICAgIC8qXG4gICAgb25LdEluaXQoKSB7XG4gICAgICAgIHRoaXMuc3RhdGUuZWxlXG4gICAgfVxuKi9cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gZWxlbVxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqL1xuICAgIGFwcGx5TG9naWMoZWxlbSwgc2NvcGUpIHtcbiAgICAgICAgZm9yKGxldCBhdHRyaWJOYW1lIG9mIGVsZW0uZ2V0QXR0cmlidXRlTmFtZXMoKSkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBLVF9GTlthdHRyaWJOYW1lXSA9PT0gXCJ1bmRlZmluZWRcIilcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIGxldCBmbiA9IEtUX0ZOW2F0dHJpYk5hbWVdO1xuICAgICAgICAgICAgZm4oZWxlbSwgZWxlbS5nZXRBdHRyaWJ1dGUoYXR0cmliTmFtZSksIHNjb3BlKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgcmVuZGVyKHNjb3BlKSB7XG4gICAgICAgIFwidXNlIHN0cmljdFwiO1xuICAgICAgICBjb25zb2xlLmxvZyhcImFwcGx5IGxvZ2ljXCIpO1xuICAgICAgICBmb3IgKGxldCBlbGVtIG9mIHRoaXMuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIHRoaXMuYXBwbHlMb2dpYyhlbGVtLCBzY29wZSk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlclJlY3Vyc2l2ZShlbGVtLCBzY29wZSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuXG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC1ibG9ja1wiLCBLdEJsb2NrKTsiLCJcblxuY2xhc3MgS3RJZiBleHRlbmRzIEtUX1JlbmRlcmFibGUge1xuXG4gICAgb25BZnRlckt0SW5pdCgpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJvbkt0SW5pdCgpXCIsIHRoaXMub3V0ZXJIVE1MKVxuICAgICAgICBsZXQga3RCbG9jayA9IHRoaXMuZmlyc3RFbGVtZW50Q2hpbGQ7XG5cbiAgICAgICAgaWYgKCAhIGt0QmxvY2sgaW5zdGFuY2VvZiBLdEJsb2NrIHx8IHR5cGVvZiBrdEJsb2NrICE9PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRWxlbWVudCBjaGlsZCBvZiB4LWt0LWZvciBtdXN0IGJlIHgta3QtYmxvY2sgaW5cIiwgdGhpcy5vdXRlckhUTUwpXG4gICAgICAgICAgICB0aHJvdyBcIkVsZW1lbnQgY2hpbGYgb2YgeC1rdC1mb3IgbXVzdCBiZSB4LWt0LWJsb2NrLlwiXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoICEgdGhpcy5oYXNBdHRyaWJ1dGUoXCJrdC1pZFwiKSkge1xuICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoXCJrdC1pZFwiLCBLVF9EQVRBLmxlbmd0aClcbiAgICAgICAgfVxuICAgICAgICBLVF9EQVRBLnB1c2goe29yaWdOb2RlOiBrdEJsb2NrfSk7XG5cbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNoaWxkKHRoaXMuY2hpbGRyZW4uaXRlbSgwKSk7XG4gICAgfVxuXG5cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgbGV0IHN0bXQgPSB0aGlzLmdldEF0dHJpYnV0ZShcInN0bXRcIik7XG5cbiAgICAgICAgbGV0IHNob3cgPSBldmFsKHN0bXQpO1xuXG4gICAgICAgIGlmIChzaG93KSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPT09IDApXG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZChLVF9EQVRBW3RoaXMuZ2V0QXR0cmlidXRlKFwia3QtaWRcIildLm9yaWdOb2RlLmNsb25lTm9kZSh0cnVlKSk7XG5cbiAgICAgICAgICAgIHRoaXMucmVuZGVyUmVjdXJzaXZlKHRoaXMuY2hpbGRyZW4uaXRlbSgwKSwgc2NvcGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCAhIHNob3cgJiYgdGhpcy5oYXNDaGlsZE5vZGVzKCkpIHtcblxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJSZWN1cnNpdmUodGhpcy5jaGlsZHJlbi5pdGVtKDApKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC1pZlwiLCBLdElmKTtcbiIsIlxuXG5jbGFzcyBLVFZhbCBleHRlbmRzIEhUTUxFbGVtZW50IHtcblxuXG5cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgbGV0IHNlbGVjdCA9IHRoaXMuZ2V0QXR0cmlidXRlKFwic2VsZWN0XCIpO1xuICAgICAgICB0aGlzLmlubmVyVGV4dCA9IHNjb3BlW3NlbGVjdF07XG4gICAgfVxuXG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC12YWxcIiwgS1RWYWwpOyIsIlxuXG5jbGFzcyBSZW5kZXJlciB7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqXG4gICAgICAgICAqIEB0eXBlIHtLVF9Gb3JEaXJlY3RpdmVbXX1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZGlyZWN0aXZlcyA9IFtcbiAgICAgICAgICAgIEtUX0ZvckRpcmVjdGl2ZVxuICAgICAgICBdXG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7SFRNTERpdkVsZW1lbnR9IG5vZGVcbiAgICAgKiBAcGFyYW0ge0tUX1JlbmRlcmFibGV9IGN1clRwbEVsZW1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9wYXJzZShub2RlLCBjdXJUcGxFbGVtKSB7XG4gICAgICAgIGxldCB0cGwgPSBudWxsO1xuICAgICAgICBsZXQgbm9kZU9yaWcgPSBudWxsO1xuICAgICAgICBjb25zb2xlLmxvZyhcInJ1blwiLCBub2RlKTtcblxuXG4gICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZShcIm5nRm9yXCIpKSB7XG4gICAgICAgICAgICBub2RlT3JpZyA9IG5vZGU7XG4gICAgICAgICAgICBub2RlID0gbm9kZS5jbG9uZU5vZGUodHJ1ZSk7XG5cbiAgICAgICAgICAgIHRwbCA9IG5ldyBLVF9Gb3JEaXJlY3RpdmUoKTtcbiAgICAgICAgICAgIHRwbC5zdGF0ZS5uZ0ZvciA9IG5vZGUuZ2V0QXR0cmlidXRlKFwibmdGb3JcIik7XG5cbiAgICAgICAgICAgIGxldCBlbGVtID0gbmV3IEtUX0ZvckVsZW1lbnQoKTtcbiAgICAgICAgICAgIC8vZWxlbS5hcHBlbmRDaGlsZChub2RlKTtcbiAgICAgICAgICAgIGVsZW0uc3RhdGUub3JpZ05vZGUgPSBub2RlO1xuXG4gICAgICAgICAgICB0cGwuc3RhdGUub3JpZ05vZGUgPSBlbGVtO1xuXG4gICAgICAgICAgICBjdXJUcGxFbGVtLnN0YXRlLnBhcmVudFRwbHMucHVzaCh0cGwpO1xuICAgICAgICAgICAgY3VyVHBsRWxlbSA9IGVsZW07XG4gICAgICAgIH1cblxuXG4gICAgICAgIGZvciAobGV0IGk9MDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuX3BhcnNlKG5vZGUuY2hpbGRyZW4uaXRlbShpKSwgY3VyVHBsRWxlbSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRwbCA9PT0gbnVsbCkge1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBub2RlT3JpZy5yZXBsYWNlV2l0aCh0cGwpO1xuXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB0ZW1wbGF0ZU5vZGVcbiAgICAgKiBAcmV0dXJuIHtLVF9UZW1wbGF0ZX1cbiAgICAgKi9cbiAgICBnZXRUZW1wbGF0ZSh0ZW1wbGF0ZU5vZGUpIHtcbiAgICAgICAgbGV0IHRwbCA9IG5ldyBLVF9UZW1wbGF0ZSgpO1xuXG4gICAgICAgIGlmICh0ZW1wbGF0ZU5vZGUgaW5zdGFuY2VvZiBIVE1MVGVtcGxhdGVFbGVtZW50KSB7XG4gICAgICAgICAgICBsZXQgbWFpbk5vZGUgPSB0ZW1wbGF0ZU5vZGUuY29udGVudC5jaGlsZHJlbi5pdGVtKDApO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUZW1wbGF0ZSBzdGFydFwiLCBtYWluTm9kZSk7XG5cbiAgICAgICAgICAgIHRlbXBsYXRlTm9kZS5wYXJlbnRFbGVtZW50Lm93bmVyRG9jdW1lbnQuYWRvcHROb2RlKG1haW5Ob2RlKTtcblxuICAgICAgICAgICAgdHBsLnN0YXRlLm9yaWdOb2RlID0gbWFpbk5vZGUuY2xvbmVOb2RlKHRydWUpO1xuICAgICAgICAgICAgdGVtcGxhdGVOb2RlLnBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQodHBsKTtcbiAgICAgICAgICAgIHRoaXMuX3BhcnNlKG1haW5Ob2RlLCB0cGwpO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0cGwuc3RhdGUub3JpZ05vZGUgPSB0ZW1wbGF0ZU5vZGU7XG4gICAgICAgICAgICB0aGlzLl9wYXJzZSh0ZW1wbGF0ZU5vZGUsIHRwbCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHBsO1xuICAgIH1cbn0iXX0=
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUva3QtcmVuZGVyYWJsZS5qcyIsImNvcmUva3QtdGVtcGxhdGUuanMiLCJmb3ItZGlyZWN0aXZlLmpzIiwia3QtYmxvY2suanMiLCJrdC1pZi5qcyIsImt0LXZhbC5qcyIsInJlbmRlcmVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqRkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDZEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoia2FzaW1pci10cGwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmNsYXNzIEtUX1JlbmRlcmFibGUgZXh0ZW5kcyBIVE1MRWxlbWVudFxue1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgb3JpZ05vZGU6IG51bGxcbiAgICAgICAgfTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gbm9kZVxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqL1xuICAgIHJlbmRlclJlY3Vyc2l2ZShub2RlLCBzY29wZSl7XG4gICAgICAgIGlmICggISBub2RlLmhhc0NoaWxkTm9kZXMoKSlcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJyZW5kZXJSZWN1cnNpdmVcIiwgbm9kZSk7XG4gICAgICAgIGZvciAobGV0IGN1ck5vZGUgb2Ygbm9kZS5jaGlsZE5vZGVzKSB7XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgY3VyTm9kZS5yZW5kZXIgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicmVuZGVyXCIsIGN1ck5vZGUpO1xuICAgICAgICAgICAgICAgIGN1ck5vZGUucmVuZGVyKHNjb3BlKTtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucmVuZGVyUmVjdXJzaXZlKGN1ck5vZGUsIHNjb3BlKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgaW5pdFJlY3Vyc2l2ZShub2RlKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygbm9kZSA9PT0gXCJ1bmRlZmluZWRcIilcbiAgICAgICAgICAgIG5vZGUgPSB0aGlzO1xuXG4gICAgICAgIGlmICh0eXBlb2Ygbm9kZS5vbkt0SW5pdCA9PT0gXCJmdW5jdGlvblwiKVxuICAgICAgICAgICAgbm9kZS5vbkt0SW5pdCgpO1xuXG4gICAgICAgIGZvciAobGV0IGN1ck5vZGUgb2Ygbm9kZS5jaGlsZE5vZGVzKSB7XG5cbiAgICAgICAgICAgIHRoaXMuaW5pdFJlY3Vyc2l2ZShjdXJOb2RlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2Ygbm9kZS5vbkFmdGVyS3RJbml0ID09PSBcImZ1bmN0aW9uXCIpXG4gICAgICAgICAgICBub2RlLm9uQWZ0ZXJLdEluaXQoKTtcbiAgICB9XG59XG5cbnZhciBLVF9GTiA9IHtcbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGVsZW1cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsXG4gICAgICogQHBhcmFtIHNjb3BlXG4gICAgICovXG4gICAgXCJbY2xhc3NdXCI6IGZ1bmN0aW9uKGVsZW0sIHZhbCwgc2NvcGUpIHtcbiAgICAgICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB2YXIgY2xhc3NlcyA9IG51bGw7XG4gICAgICAgICAgICBsZXQgZSA9IFwiY2xhc3NlcyA9IFwiICsgdmFsO1xuICAgICAgICAgICAgbGV0IHJldCA9IGV2YWwoZSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImV2YWxcIiwgZSwgXCJyZXQ6IFwiLCByZXQsIFwiY2xhc3NlczpcIiwgY2xhc3Nlcyk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRocm93IGUgKyBcIiBpbiBbZGF0YV0gb2YgXCIgKyBlbGVtLm91dGVySFRNTDtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGxldCBjbGFzc05hbWUgaW4gY2xhc3Nlcykge1xuICAgICAgICAgICAgaWYgKCAhIGNsYXNzZXMuaGFzT3duUHJvcGVydHkoY2xhc3NOYW1lKSlcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIGlmIChjbGFzc2VzW2NsYXNzTmFtZV0gPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICBlbGVtLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZWxlbS5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59O1xudmFyIEtUX0RBVEEgPSBbXTtcblxuIiwiY2xhc3MgS1RfVGVtcGxhdGUgZXh0ZW5kcyBLVF9SZW5kZXJhYmxlXG57XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuaXNSZW5kZXJlZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIHJlbmRlcihzY29wZSkge1xuICAgICAgICBpZiAodGhpcy5pc1JlbmRlcmVkID09PSBmYWxzZSkge1xuICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh0aGlzLnN0YXRlLm9yaWdOb2RlLmNsb25lTm9kZSh0cnVlKSk7XG4gICAgICAgICAgICB0aGlzLmlzUmVuZGVyZWQgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuc3RhdGUucGFyZW50VHBscy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5wYXJlbnRUcGxzW2ldLnJlbmRlcihzY29wZSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coXCJEdW1wIGZyb20gdHBsOiBcIiwgdGhpcy5kdW1wKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHRhcmdldE5vZGVcbiAgICAgKiBAcmV0dXJuIHtLVF9UZW1wbGF0ZX1cbiAgICAgKi9cbiAgICBtb3VudCh0YXJnZXROb2RlKSB7XG5cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC10ZW1wbGF0ZVwiLCBLVF9UZW1wbGF0ZSk7XG4iLCJjbGFzcyBLVF9Gb3JEaXJlY3RpdmUgZXh0ZW5kcyBLVF9SZW5kZXJhYmxlIHtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhcImNvbnN0cnVjdFwiLCB0aGlzLm91dGVySFRNTCk7XG4gICAgICAgIHRoaXMuc3RhdGUubGVuID0gMDtcbiAgICB9XG5cblxuICAgIG9uS3RJbml0KCkge1xuXG4gICAgfVxuXG4gICAgb25BZnRlckt0SW5pdCgpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJvbkt0SW5pdCgpXCIsIHRoaXMub3V0ZXJIVE1MKVxuICAgICAgICBsZXQga3RCbG9jayA9IHRoaXMuZmlyc3RFbGVtZW50Q2hpbGQ7XG5cbiAgICAgICAgaWYgKCAhIGt0QmxvY2sgaW5zdGFuY2VvZiBLdEJsb2NrIHx8IHR5cGVvZiBrdEJsb2NrICE9PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRWxlbWVudCBjaGlsZCBvZiB4LWt0LWZvciBtdXN0IGJlIHgta3QtYmxvY2sgaW5cIiwgdGhpcy5vdXRlckhUTUwpXG4gICAgICAgICAgICB0aHJvdyBcIkVsZW1lbnQgY2hpbGYgb2YgeC1rdC1mb3IgbXVzdCBiZSB4LWt0LWJsb2NrLlwiXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoICEgdGhpcy5oYXNBdHRyaWJ1dGUoXCJrdC1pZFwiKSkge1xuICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoXCJrdC1pZFwiLCBLVF9EQVRBLmxlbmd0aClcbiAgICAgICAgfVxuICAgICAgICBLVF9EQVRBLnB1c2goe29yaWdOb2RlOiBrdEJsb2NrfSk7XG5cbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNoaWxkKHRoaXMuY2hpbGRyZW4uaXRlbSgwKSk7XG4gICAgfVxuXG4gICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgfVxuXG4gICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiZGlzY29ubmVjdGVkXCIsIHRoaXMub3V0ZXJIVE1MKTtcbiAgICB9XG5cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgbGV0IGt0SWQgPSBwYXJzZUludCh0aGlzLmdldEF0dHJpYnV0ZShcImt0LWlkXCIpKTtcbiAgICAgICAgbGV0IHJlc3VsdCA9IG5ldyBSZWdFeHAoXCJsZXQgKFxcXFx3Kykgb2YgKFthLXpBLVowLTlfLl0rKVwiKTtcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmV4ZWModGhpcy5nZXRBdHRyaWJ1dGUoXCJmb3JcIikpO1xuXG4gICAgICAgIGxldCBzZWxlY3RvciA9IHJlc3VsdFsyXTtcbiAgICAgICAgbGV0IHRhcmdldCA9IHJlc3VsdFsxXTtcblxuICAgICAgICBsZXQgdmFsID0gc2NvcGVbc2VsZWN0b3JdO1xuXG4gICAgICAgIC8vY29uc29sZS5sb2coXCJyZW5kZXIoKSBzY29wZTogXCIsIHNjb3BlLCBcInZhbHVlOlwiLCB2YWwpO1xuXG4gICAgICAgIC8vIENyZWF0ZSBuZXcgZWxlbWVudHNcbiAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuc3RhdGUubGVuOyBpIDwgdmFsLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiYXBwZW5kXCIsICBcInRvXCIsIHRoaXMub3V0ZXJIVE1MLCB0aGlzLnN0YXRlKTtcbiAgICAgICAgICAgIGxldCBlID0gS1RfREFUQVtrdElkXS5vcmlnTm9kZS5jbG9uZU5vZGUodHJ1ZSk7XG4gICAgICAgICAgICAvLyB0aGlzLm93bmVyRG9jdW1lbnQuYWRvcHROb2RlKGUpO1xuXG4gICAgICAgICAgICB0aGlzLmFwcGVuZChlKTtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUubGVuKys7XG4gICAgICAgIH1cblxuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nIChcIlJlZnJlc2hcIiwgaSwgYHdpdGggc2NvcGVbJHt0YXJnZXR9XSA9ICcke3ZhbFtpXX0nYCk7XG4gICAgICAgICAgICBzY29wZVt0YXJnZXRdID0gdmFsW2ldO1xuICAgICAgICAgICAgc2NvcGVbXCJpZHhcIl0gPSBpO1xuICAgICAgICAgICAgbGV0IGN1ck5vZGUgPSB0aGlzLmNoaWxkcmVuLml0ZW0oaSk7XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nIChcIm5vZGUgaXNcIiwgY3VyTm9kZSwgdGhpcy5jaGlsZHJlbik7XG4gICAgICAgICAgICBjdXJOb2RlLnJlbmRlcihzY29wZSk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIGZvciAobGV0IGkgPSB0aGlzLnN0YXRlLmxlbjsgaSA+IHZhbC5sZW5ndGg7IGktLSkge1xuICAgICAgICAgICAgLy8gICAgbGV0IGMgPSB0aGlzLnN0YXRlLnBhcmVudFRwbHMucG9wKCk7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNoaWxkKHRoaXMubGFzdEVsZW1lbnRDaGlsZCk7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLmxlbi0tO1xuICAgICAgICB9XG5cbiAgICB9XG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC1mb3JcIiwgS1RfRm9yRGlyZWN0aXZlKTsiLCJjbGFzcyBLdEJsb2NrIGV4dGVuZHMgS1RfUmVuZGVyYWJsZSB7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5lbGVtZW50cyA9IFtdO1xuICAgIH1cblxuICAgIGNvbm50ZWN0ZWRDYWxsYmFjaygpIHtcblxuICAgIH1cblxuICAgIC8qXG4gICAgb25LdEluaXQoKSB7XG4gICAgICAgIHRoaXMuc3RhdGUuZWxlXG4gICAgfVxuKi9cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gZWxlbVxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqL1xuICAgIGFwcGx5TG9naWMoZWxlbSwgc2NvcGUpIHtcbiAgICAgICAgZm9yKGxldCBhdHRyaWJOYW1lIG9mIGVsZW0uZ2V0QXR0cmlidXRlTmFtZXMoKSkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBLVF9GTlthdHRyaWJOYW1lXSA9PT0gXCJ1bmRlZmluZWRcIilcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIGxldCBmbiA9IEtUX0ZOW2F0dHJpYk5hbWVdO1xuICAgICAgICAgICAgZm4oZWxlbSwgZWxlbS5nZXRBdHRyaWJ1dGUoYXR0cmliTmFtZSksIHNjb3BlKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgcmVuZGVyKHNjb3BlKSB7XG4gICAgICAgIFwidXNlIHN0cmljdFwiO1xuICAgICAgICBjb25zb2xlLmxvZyhcImFwcGx5IGxvZ2ljXCIpO1xuICAgICAgICBmb3IgKGxldCBlbGVtIG9mIHRoaXMuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIHRoaXMuYXBwbHlMb2dpYyhlbGVtLCBzY29wZSk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlclJlY3Vyc2l2ZShlbGVtLCBzY29wZSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuXG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC1ibG9ja1wiLCBLdEJsb2NrKTsiLCJcblxuY2xhc3MgS3RJZiBleHRlbmRzIEtUX1JlbmRlcmFibGUge1xuXG4gICAgb25BZnRlckt0SW5pdCgpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJvbkt0SW5pdCgpXCIsIHRoaXMub3V0ZXJIVE1MKVxuICAgICAgICBsZXQga3RCbG9jayA9IHRoaXMuZmlyc3RFbGVtZW50Q2hpbGQ7XG5cbiAgICAgICAgaWYgKCAhIGt0QmxvY2sgaW5zdGFuY2VvZiBLdEJsb2NrIHx8IHR5cGVvZiBrdEJsb2NrICE9PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRWxlbWVudCBjaGlsZCBvZiB4LWt0LWZvciBtdXN0IGJlIHgta3QtYmxvY2sgaW5cIiwgdGhpcy5vdXRlckhUTUwpXG4gICAgICAgICAgICB0aHJvdyBcIkVsZW1lbnQgY2hpbGYgb2YgeC1rdC1mb3IgbXVzdCBiZSB4LWt0LWJsb2NrLlwiXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoICEgdGhpcy5oYXNBdHRyaWJ1dGUoXCJrdC1pZFwiKSkge1xuICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoXCJrdC1pZFwiLCBLVF9EQVRBLmxlbmd0aClcbiAgICAgICAgfVxuICAgICAgICBLVF9EQVRBLnB1c2goe29yaWdOb2RlOiBrdEJsb2NrfSk7XG5cbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNoaWxkKHRoaXMuY2hpbGRyZW4uaXRlbSgwKSk7XG4gICAgfVxuXG5cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgbGV0IHN0bXQgPSB0aGlzLmdldEF0dHJpYnV0ZShcInN0bXRcIik7XG5cbiAgICAgICAgbGV0IHNob3cgPSBldmFsKHN0bXQpO1xuXG4gICAgICAgIGlmIChzaG93KSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPT09IDApXG4gICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZChLVF9EQVRBW3RoaXMuZ2V0QXR0cmlidXRlKFwia3QtaWRcIildLm9yaWdOb2RlLmNsb25lTm9kZSh0cnVlKSk7XG5cbiAgICAgICAgICAgIHRoaXMucmVuZGVyUmVjdXJzaXZlKHRoaXMuY2hpbGRyZW4uaXRlbSgwKSwgc2NvcGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCAhIHNob3cgJiYgdGhpcy5oYXNDaGlsZE5vZGVzKCkpIHtcblxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJSZWN1cnNpdmUodGhpcy5jaGlsZHJlbi5pdGVtKDApKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC1pZlwiLCBLdElmKTtcbiIsIlxuXG5jbGFzcyBLVFZhbCBleHRlbmRzIEhUTUxFbGVtZW50IHtcblxuXG5cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgbGV0IHNlbGVjdCA9IHRoaXMuZ2V0QXR0cmlidXRlKFwic2VsZWN0XCIpO1xuICAgICAgICB0aGlzLmlubmVyVGV4dCA9IHNjb3BlW3NlbGVjdF07XG4gICAgfVxuXG5cbn1cblxuY3VzdG9tRWxlbWVudHMuZGVmaW5lKFwieC1rdC12YWxcIiwgS1RWYWwpOyIsIlxuXG5jbGFzcyBSZW5kZXJlciB7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqXG4gICAgICAgICAqIEB0eXBlIHtLVF9Gb3JEaXJlY3RpdmVbXX1cbiAgICAgICAgICovXG4gICAgICAgIHRoaXMuZGlyZWN0aXZlcyA9IFtcbiAgICAgICAgICAgIEtUX0ZvckRpcmVjdGl2ZVxuICAgICAgICBdXG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7SFRNTERpdkVsZW1lbnR9IG5vZGVcbiAgICAgKiBAcGFyYW0ge0tUX1JlbmRlcmFibGV9IGN1clRwbEVsZW1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIF9wYXJzZShub2RlLCBjdXJUcGxFbGVtKSB7XG4gICAgICAgIGxldCB0cGwgPSBudWxsO1xuICAgICAgICBsZXQgbm9kZU9yaWcgPSBudWxsO1xuICAgICAgICBjb25zb2xlLmxvZyhcInJ1blwiLCBub2RlKTtcblxuXG4gICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZShcIm5nRm9yXCIpKSB7XG4gICAgICAgICAgICBub2RlT3JpZyA9IG5vZGU7XG4gICAgICAgICAgICBub2RlID0gbm9kZS5jbG9uZU5vZGUodHJ1ZSk7XG5cbiAgICAgICAgICAgIHRwbCA9IG5ldyBLVF9Gb3JEaXJlY3RpdmUoKTtcbiAgICAgICAgICAgIHRwbC5zdGF0ZS5uZ0ZvciA9IG5vZGUuZ2V0QXR0cmlidXRlKFwibmdGb3JcIik7XG5cbiAgICAgICAgICAgIGxldCBlbGVtID0gbmV3IEtUX0ZvckVsZW1lbnQoKTtcbiAgICAgICAgICAgIC8vZWxlbS5hcHBlbmRDaGlsZChub2RlKTtcbiAgICAgICAgICAgIGVsZW0uc3RhdGUub3JpZ05vZGUgPSBub2RlO1xuXG4gICAgICAgICAgICB0cGwuc3RhdGUub3JpZ05vZGUgPSBlbGVtO1xuXG4gICAgICAgICAgICBjdXJUcGxFbGVtLnN0YXRlLnBhcmVudFRwbHMucHVzaCh0cGwpO1xuICAgICAgICAgICAgY3VyVHBsRWxlbSA9IGVsZW07XG4gICAgICAgIH1cblxuXG4gICAgICAgIGZvciAobGV0IGk9MDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuX3BhcnNlKG5vZGUuY2hpbGRyZW4uaXRlbShpKSwgY3VyVHBsRWxlbSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRwbCA9PT0gbnVsbCkge1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBub2RlT3JpZy5yZXBsYWNlV2l0aCh0cGwpO1xuXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB0ZW1wbGF0ZU5vZGVcbiAgICAgKiBAcmV0dXJuIHtLVF9UZW1wbGF0ZX1cbiAgICAgKi9cbiAgICBnZXRUZW1wbGF0ZSh0ZW1wbGF0ZU5vZGUpIHtcbiAgICAgICAgbGV0IHRwbCA9IG5ldyBLVF9UZW1wbGF0ZSgpO1xuXG4gICAgICAgIGlmICh0ZW1wbGF0ZU5vZGUgaW5zdGFuY2VvZiBIVE1MVGVtcGxhdGVFbGVtZW50KSB7XG4gICAgICAgICAgICBsZXQgbWFpbk5vZGUgPSB0ZW1wbGF0ZU5vZGUuY29udGVudC5jaGlsZHJlbi5pdGVtKDApO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJUZW1wbGF0ZSBzdGFydFwiLCBtYWluTm9kZSk7XG5cbiAgICAgICAgICAgIHRlbXBsYXRlTm9kZS5wYXJlbnRFbGVtZW50Lm93bmVyRG9jdW1lbnQuYWRvcHROb2RlKG1haW5Ob2RlKTtcblxuICAgICAgICAgICAgdHBsLnN0YXRlLm9yaWdOb2RlID0gbWFpbk5vZGUuY2xvbmVOb2RlKHRydWUpO1xuICAgICAgICAgICAgdGVtcGxhdGVOb2RlLnBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQodHBsKTtcbiAgICAgICAgICAgIHRoaXMuX3BhcnNlKG1haW5Ob2RlLCB0cGwpO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0cGwuc3RhdGUub3JpZ05vZGUgPSB0ZW1wbGF0ZU5vZGU7XG4gICAgICAgICAgICB0aGlzLl9wYXJzZSh0ZW1wbGF0ZU5vZGUsIHRwbCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHBsO1xuICAgIH1cbn0iXX0=
/**
 * Infracamp's Kasimir Templates
 *
 * A no-dependency render on request
 *
 * @author Matthias Leuffen <m@tth.es>
 */


/**
 *
 * @param templateSelector
 * @return {KasimirTemplate}
 */
function kasimir_tpl(templateSelector) {
    let tplElem = null;
    if (typeof templateSelector === "string") {
        tplElem = document.querySelector(templateSelector);
        if (tplElem === null)
            throw "kasimir_tpl(): can't find element '" + templateSelector + "'";
    } else if (templateSelector instanceof HTMLElement) {
        tplElem = templateSelector;
    } else {
        throw "kasimir_tpl(): parameter1 is not a HtmlElement";
    }
    let renderer = new KasimirRenderer();
    return renderer.render(tplElem);
}



class KasimirRenderer {

    constructor(attrPrefix="*") {
        this._attrPrefix = attrPrefix
    }

    /**
     *
     * @param domnode {HTMLElement}
     */
    _getAttributeStr(domnode) {
        let ret = "";
        for (let attr of domnode.attributes)
            ret += " " + attr.name + "=\"" + attr.value + "\"";
        return ret;
    }


    _addslashes(string) {
        return string.replace(/\\/g, '\\\\').
            replace(/\u0008/g, '\\b').
            replace(/\t/g, '\\t').
            replace(/\n/g, '\\n').
            replace(/\f/g, '\\f').
            replace(/\r/g, '\\r').
            replace(/'/g, '\\\'').
            replace(/"/g, '\\"');
    }

    /**
     *
     * @param domnode {HTMLElement}
     * @return
     */
    _getLogic(domnode) {
        let ret = {open:"", close:"", handler:{}};

        if (domnode.hasAttribute(this._attrPrefix + "if")) {
            ret.open += "if(" + domnode.getAttribute(this._attrPrefix + "if") + "){";
            ret.close += "}";
        }
        if (domnode.hasAttribute(this._attrPrefix + "for")) {
            ret.open += "for(" + domnode.getAttribute(this._attrPrefix + "for") + "){";
            ret.close += "}";
        }

        for (let attr of domnode.attributes) {
            let matches = attr.name.match(/^on(.+)/);
            if (matches === null)
                continue;
            ret.handler[attr.name] = attr.value;
        }

        return ret;
    }

    /**
     *
     * @param domnode {Node}
     * @param path {String}
     * @param depth
     */
    _render(domnode, path, depth) {
        let out = "";


        console.log(domnode);
        if (domnode instanceof HTMLElement) {

            let logic = this._getLogic(domnode);
            let attrStr = this._getAttributeStr(domnode);
            let curPath = path + " > " + domnode.tagName + attrStr;
            out += "\n" + logic.open;

            out += "\n__debug_path__ = '" + this._addslashes(curPath) + "';";
            if (domnode.tagName === "SCRIPT") {
                out += "\neval(`" + domnode.textContent + "`);"
            } else {
                out += "\n_e[" + depth + "] = document.createElement('" + domnode.tagName + "');";

                for (let handlerName in logic.handler) {
                    out += "\n_e[" + depth + "]." + handlerName + " = function(e){ " + logic.handler[handlerName] + " };";
                }

                out += "\n_e[" + (depth - 1) + "].appendChild(_e[" + depth + "]);";
                // out += "\n__html__ += `<" + domnode.tagName + attrStr + ">`;";
                for (let child of domnode.childNodes) {
                    out += this._render(child, curPath, depth + 1);
                }
            }
            //out += "\n__html__ += `</" + domnode.tagName + ">`;"
            out += "\n" + logic.close;
        } else if (domnode instanceof Text) {
            let curPath = path + " > (text)";
            out += "\n__debug_path__ = '" + this._addslashes(curPath) + "';";
            out += "\n_e[" + (depth-1) +"].appendChild(document.createTextNode(`" + domnode.textContent + "`));";
        }
        return out
    }


    /**
     *
     * @param domnode
     * @return {KasimirTemplate}
     */
    render(domnode) {
        let out = "var __debug_path__ = '(root)';";
        out += "\nvar _e = [document.createElement('div')];";


        if (domnode instanceof HTMLTemplateElement) {

            for (let curChild of domnode.content.childNodes) {
                out += this._render(curChild,  "(root)", 1);
            }
        } else {
            out += this._render(domnode,  "(root)", 1);
        }


        let xout = `
            fn = function(scope){
                let fns = [];
                try {
                    ${out}
                } catch (e) {
                    throw 'Error in ' + __debug_path__ + ': ' + e;
                }
                return _e[0];
            };
        `;

        console.log(xout);
        let fn ;
        eval(xout);
        return new KasimirTemplate(fn);
    }

}


class KasimirTemplate {

    constructor(tplFn) {
        this._tplFn = tplFn;
        /**
         *
         * @type {HTMLElement}
         * @private
         */
        this._bind = null;
    }

    /**
     *
     * @param domSelector {string|HTMLElement}
     * @return KasimirTemplate
     */
    bind(domSelector) {
        let node = null;
        if (typeof domSelector === "string") {
            node = document.querySelector(domSelector);
            if (node === null)
                throw "bind(): can't find element '" + domSelector + "'";
        } else if (domSelector instanceof HTMLElement) {
            node = domSelector;
        } else {
            throw "bind(): parameter1 is not a HtmlElement";
        }
        this._bind = node;
        return this;
    }


    /**
     *
     * @param scope
     * @return {KasimirTemplate}
     */
    render(scope) {
        console.log(this._tplFn(scope));
        this._bind.replaceChild(this._tplFn(scope), this._bind.firstChild);
        return this;
    }

    /**
     *
     * @param scope
     * @return {KasimirTemplate}
     */
    observe(scope) {
        this.render(scope);
        window.setInterval(e => {
            if (JSON.stringify(scope) !== this._observedLastValue) {
                this._observedLastValue = JSON.stringify(scope);
                this.render(scope);
            }
        }, 200);
        return this;
    }

}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZ1bmN0aW9ucy5qcyIsImthc2ltaXItcmVuZGVyZXIuanMiLCJrYXNpbWlyLXRlbXBsYXRlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDckJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQy9JQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoia2FzaW1pci10cGwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcblxuLyoqXG4gKlxuICogQHBhcmFtIHRlbXBsYXRlU2VsZWN0b3JcbiAqIEByZXR1cm4ge0thc2ltaXJUZW1wbGF0ZX1cbiAqL1xuZnVuY3Rpb24ga2FzaW1pcl90cGwodGVtcGxhdGVTZWxlY3Rvcikge1xuICAgIGxldCB0cGxFbGVtID0gbnVsbDtcbiAgICBpZiAodHlwZW9mIHRlbXBsYXRlU2VsZWN0b3IgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgdHBsRWxlbSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGVtcGxhdGVTZWxlY3Rvcik7XG4gICAgICAgIGlmICh0cGxFbGVtID09PSBudWxsKVxuICAgICAgICAgICAgdGhyb3cgXCJrYXNpbWlyX3RwbCgpOiBjYW4ndCBmaW5kIGVsZW1lbnQgJ1wiICsgdGVtcGxhdGVTZWxlY3RvciArIFwiJ1wiO1xuICAgIH0gZWxzZSBpZiAodGVtcGxhdGVTZWxlY3RvciBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG4gICAgICAgIHRwbEVsZW0gPSB0ZW1wbGF0ZVNlbGVjdG9yO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IFwia2FzaW1pcl90cGwoKTogcGFyYW1ldGVyMSBpcyBub3QgYSBIdG1sRWxlbWVudFwiO1xuICAgIH1cbiAgICBsZXQgcmVuZGVyZXIgPSBuZXcgS2FzaW1pclJlbmRlcmVyKCk7XG4gICAgcmV0dXJuIHJlbmRlcmVyLnJlbmRlcih0cGxFbGVtKTtcbn1cbiIsIlxuXG5jbGFzcyBLYXNpbWlyUmVuZGVyZXIge1xuXG4gICAgY29uc3RydWN0b3IoYXR0clByZWZpeD1cIipcIikge1xuICAgICAgICB0aGlzLl9hdHRyUHJlZml4ID0gYXR0clByZWZpeFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIGRvbW5vZGUge0hUTUxFbGVtZW50fVxuICAgICAqL1xuICAgIF9nZXRBdHRyaWJ1dGVTdHIoZG9tbm9kZSkge1xuICAgICAgICBsZXQgcmV0ID0gXCJcIjtcbiAgICAgICAgZm9yIChsZXQgYXR0ciBvZiBkb21ub2RlLmF0dHJpYnV0ZXMpXG4gICAgICAgICAgICByZXQgKz0gXCIgXCIgKyBhdHRyLm5hbWUgKyBcIj1cXFwiXCIgKyBhdHRyLnZhbHVlICsgXCJcXFwiXCI7XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuXG5cbiAgICBfYWRkc2xhc2hlcyhzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9cXFxcL2csICdcXFxcXFxcXCcpLlxuICAgICAgICAgICAgcmVwbGFjZSgvXFx1MDAwOC9nLCAnXFxcXGInKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1xcdC9nLCAnXFxcXHQnKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1xcbi9nLCAnXFxcXG4nKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1xcZi9nLCAnXFxcXGYnKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1xcci9nLCAnXFxcXHInKS5cbiAgICAgICAgICAgIHJlcGxhY2UoLycvZywgJ1xcXFxcXCcnKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1wiL2csICdcXFxcXCInKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkb21ub2RlIHtIVE1MRWxlbWVudH1cbiAgICAgKiBAcmV0dXJuXG4gICAgICovXG4gICAgX2dldExvZ2ljKGRvbW5vZGUpIHtcbiAgICAgICAgbGV0IHJldCA9IHtvcGVuOlwiXCIsIGNsb3NlOlwiXCIsIGhhbmRsZXI6e319O1xuXG4gICAgICAgIGlmIChkb21ub2RlLmhhc0F0dHJpYnV0ZSh0aGlzLl9hdHRyUHJlZml4ICsgXCJpZlwiKSkge1xuICAgICAgICAgICAgcmV0Lm9wZW4gKz0gXCJpZihcIiArIGRvbW5vZGUuZ2V0QXR0cmlidXRlKHRoaXMuX2F0dHJQcmVmaXggKyBcImlmXCIpICsgXCIpe1wiO1xuICAgICAgICAgICAgcmV0LmNsb3NlICs9IFwifVwiO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkb21ub2RlLmhhc0F0dHJpYnV0ZSh0aGlzLl9hdHRyUHJlZml4ICsgXCJmb3JcIikpIHtcbiAgICAgICAgICAgIHJldC5vcGVuICs9IFwiZm9yKFwiICsgZG9tbm9kZS5nZXRBdHRyaWJ1dGUodGhpcy5fYXR0clByZWZpeCArIFwiZm9yXCIpICsgXCIpe1wiO1xuICAgICAgICAgICAgcmV0LmNsb3NlICs9IFwifVwiO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgYXR0ciBvZiBkb21ub2RlLmF0dHJpYnV0ZXMpIHtcbiAgICAgICAgICAgIGxldCBtYXRjaGVzID0gYXR0ci5uYW1lLm1hdGNoKC9eb24oLispLyk7XG4gICAgICAgICAgICBpZiAobWF0Y2hlcyA9PT0gbnVsbClcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIHJldC5oYW5kbGVyW2F0dHIubmFtZV0gPSBhdHRyLnZhbHVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkb21ub2RlIHtOb2RlfVxuICAgICAqIEBwYXJhbSBwYXRoIHtTdHJpbmd9XG4gICAgICogQHBhcmFtIGRlcHRoXG4gICAgICovXG4gICAgX3JlbmRlcihkb21ub2RlLCBwYXRoLCBkZXB0aCkge1xuICAgICAgICBsZXQgb3V0ID0gXCJcIjtcblxuXG4gICAgICAgIGNvbnNvbGUubG9nKGRvbW5vZGUpO1xuICAgICAgICBpZiAoZG9tbm9kZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG5cbiAgICAgICAgICAgIGxldCBsb2dpYyA9IHRoaXMuX2dldExvZ2ljKGRvbW5vZGUpO1xuICAgICAgICAgICAgbGV0IGF0dHJTdHIgPSB0aGlzLl9nZXRBdHRyaWJ1dGVTdHIoZG9tbm9kZSk7XG4gICAgICAgICAgICBsZXQgY3VyUGF0aCA9IHBhdGggKyBcIiA+IFwiICsgZG9tbm9kZS50YWdOYW1lICsgYXR0clN0cjtcbiAgICAgICAgICAgIG91dCArPSBcIlxcblwiICsgbG9naWMub3BlbjtcblxuICAgICAgICAgICAgb3V0ICs9IFwiXFxuX19kZWJ1Z19wYXRoX18gPSAnXCIgKyB0aGlzLl9hZGRzbGFzaGVzKGN1clBhdGgpICsgXCInO1wiO1xuICAgICAgICAgICAgaWYgKGRvbW5vZGUudGFnTmFtZSA9PT0gXCJTQ1JJUFRcIikge1xuICAgICAgICAgICAgICAgIG91dCArPSBcIlxcbmV2YWwoYFwiICsgZG9tbm9kZS50ZXh0Q29udGVudCArIFwiYCk7XCJcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb3V0ICs9IFwiXFxuX2VbXCIgKyBkZXB0aCArIFwiXSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ1wiICsgZG9tbm9kZS50YWdOYW1lICsgXCInKTtcIjtcblxuICAgICAgICAgICAgICAgIGZvciAobGV0IGhhbmRsZXJOYW1lIGluIGxvZ2ljLmhhbmRsZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgb3V0ICs9IFwiXFxuX2VbXCIgKyBkZXB0aCArIFwiXS5cIiArIGhhbmRsZXJOYW1lICsgXCIgPSBmdW5jdGlvbihlKXsgXCIgKyBsb2dpYy5oYW5kbGVyW2hhbmRsZXJOYW1lXSArIFwiIH07XCI7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgb3V0ICs9IFwiXFxuX2VbXCIgKyAoZGVwdGggLSAxKSArIFwiXS5hcHBlbmRDaGlsZChfZVtcIiArIGRlcHRoICsgXCJdKTtcIjtcbiAgICAgICAgICAgICAgICAvLyBvdXQgKz0gXCJcXG5fX2h0bWxfXyArPSBgPFwiICsgZG9tbm9kZS50YWdOYW1lICsgYXR0clN0ciArIFwiPmA7XCI7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgY2hpbGQgb2YgZG9tbm9kZS5jaGlsZE5vZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgIG91dCArPSB0aGlzLl9yZW5kZXIoY2hpbGQsIGN1clBhdGgsIGRlcHRoICsgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy9vdXQgKz0gXCJcXG5fX2h0bWxfXyArPSBgPC9cIiArIGRvbW5vZGUudGFnTmFtZSArIFwiPmA7XCJcbiAgICAgICAgICAgIG91dCArPSBcIlxcblwiICsgbG9naWMuY2xvc2U7XG4gICAgICAgIH0gZWxzZSBpZiAoZG9tbm9kZSBpbnN0YW5jZW9mIFRleHQpIHtcbiAgICAgICAgICAgIGxldCBjdXJQYXRoID0gcGF0aCArIFwiID4gKHRleHQpXCI7XG4gICAgICAgICAgICBvdXQgKz0gXCJcXG5fX2RlYnVnX3BhdGhfXyA9ICdcIiArIHRoaXMuX2FkZHNsYXNoZXMoY3VyUGF0aCkgKyBcIic7XCI7XG4gICAgICAgICAgICBvdXQgKz0gXCJcXG5fZVtcIiArIChkZXB0aC0xKSArXCJdLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGBcIiArIGRvbW5vZGUudGV4dENvbnRlbnQgKyBcImApKTtcIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gb3V0XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkb21ub2RlXG4gICAgICogQHJldHVybiB7S2FzaW1pclRlbXBsYXRlfVxuICAgICAqL1xuICAgIHJlbmRlcihkb21ub2RlKSB7XG4gICAgICAgIGxldCBvdXQgPSBcInZhciBfX2RlYnVnX3BhdGhfXyA9ICcocm9vdCknO1wiO1xuICAgICAgICBvdXQgKz0gXCJcXG52YXIgX2UgPSBbZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyldO1wiO1xuXG5cbiAgICAgICAgaWYgKGRvbW5vZGUgaW5zdGFuY2VvZiBIVE1MVGVtcGxhdGVFbGVtZW50KSB7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGN1ckNoaWxkIG9mIGRvbW5vZGUuY29udGVudC5jaGlsZE5vZGVzKSB7XG4gICAgICAgICAgICAgICAgb3V0ICs9IHRoaXMuX3JlbmRlcihjdXJDaGlsZCwgIFwiKHJvb3QpXCIsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3V0ICs9IHRoaXMuX3JlbmRlcihkb21ub2RlLCAgXCIocm9vdClcIiwgMSk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIGxldCB4b3V0ID0gYFxuICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihzY29wZSl7XG4gICAgICAgICAgICAgICAgbGV0IGZucyA9IFtdO1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICR7b3V0fVxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgJ0Vycm9yIGluICcgKyBfX2RlYnVnX3BhdGhfXyArICc6ICcgKyBlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gX2VbMF07XG4gICAgICAgICAgICB9O1xuICAgICAgICBgO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKHhvdXQpO1xuICAgICAgICBsZXQgZm4gO1xuICAgICAgICBldmFsKHhvdXQpO1xuICAgICAgICByZXR1cm4gbmV3IEthc2ltaXJUZW1wbGF0ZShmbik7XG4gICAgfVxuXG59XG5cbiIsImNsYXNzIEthc2ltaXJUZW1wbGF0ZSB7XG5cbiAgICBjb25zdHJ1Y3Rvcih0cGxGbikge1xuICAgICAgICB0aGlzLl90cGxGbiA9IHRwbEZuO1xuICAgICAgICAvKipcbiAgICAgICAgICpcbiAgICAgICAgICogQHR5cGUge0hUTUxFbGVtZW50fVxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fYmluZCA9IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZG9tU2VsZWN0b3Ige3N0cmluZ3xIVE1MRWxlbWVudH1cbiAgICAgKiBAcmV0dXJuIEthc2ltaXJUZW1wbGF0ZVxuICAgICAqL1xuICAgIGJpbmQoZG9tU2VsZWN0b3IpIHtcbiAgICAgICAgbGV0IG5vZGUgPSBudWxsO1xuICAgICAgICBpZiAodHlwZW9mIGRvbVNlbGVjdG9yID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihkb21TZWxlY3Rvcik7XG4gICAgICAgICAgICBpZiAobm9kZSA9PT0gbnVsbClcbiAgICAgICAgICAgICAgICB0aHJvdyBcImJpbmQoKTogY2FuJ3QgZmluZCBlbGVtZW50ICdcIiArIGRvbVNlbGVjdG9yICsgXCInXCI7XG4gICAgICAgIH0gZWxzZSBpZiAoZG9tU2VsZWN0b3IgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgbm9kZSA9IGRvbVNlbGVjdG9yO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgXCJiaW5kKCk6IHBhcmFtZXRlcjEgaXMgbm90IGEgSHRtbEVsZW1lbnRcIjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9iaW5kID0gbm9kZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqIEByZXR1cm4ge0thc2ltaXJUZW1wbGF0ZX1cbiAgICAgKi9cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5fdHBsRm4oc2NvcGUpKTtcbiAgICAgICAgdGhpcy5fYmluZC5yZXBsYWNlQ2hpbGQodGhpcy5fdHBsRm4oc2NvcGUpLCB0aGlzLl9iaW5kLmZpcnN0Q2hpbGQpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqIEByZXR1cm4ge0thc2ltaXJUZW1wbGF0ZX1cbiAgICAgKi9cbiAgICBvYnNlcnZlKHNjb3BlKSB7XG4gICAgICAgIHRoaXMucmVuZGVyKHNjb3BlKTtcbiAgICAgICAgd2luZG93LnNldEludGVydmFsKGUgPT4ge1xuICAgICAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KHNjb3BlKSAhPT0gdGhpcy5fb2JzZXJ2ZWRMYXN0VmFsdWUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9vYnNlcnZlZExhc3RWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KHNjb3BlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcihzY29wZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIDIwMCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxufVxuXG4iXX0=
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZ1bmN0aW9ucy5qcyIsImthc2ltaXItcmVuZGVyZXIuanMiLCJrYXNpbWlyLXRlbXBsYXRlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDckJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQy9JQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoia2FzaW1pci10cGwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcblxuLyoqXG4gKlxuICogQHBhcmFtIHRlbXBsYXRlU2VsZWN0b3JcbiAqIEByZXR1cm4ge0thc2ltaXJUZW1wbGF0ZX1cbiAqL1xuZnVuY3Rpb24ga2FzaW1pcl90cGwodGVtcGxhdGVTZWxlY3Rvcikge1xuICAgIGxldCB0cGxFbGVtID0gbnVsbDtcbiAgICBpZiAodHlwZW9mIHRlbXBsYXRlU2VsZWN0b3IgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgdHBsRWxlbSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGVtcGxhdGVTZWxlY3Rvcik7XG4gICAgICAgIGlmICh0cGxFbGVtID09PSBudWxsKVxuICAgICAgICAgICAgdGhyb3cgXCJrYXNpbWlyX3RwbCgpOiBjYW4ndCBmaW5kIGVsZW1lbnQgJ1wiICsgdGVtcGxhdGVTZWxlY3RvciArIFwiJ1wiO1xuICAgIH0gZWxzZSBpZiAodGVtcGxhdGVTZWxlY3RvciBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG4gICAgICAgIHRwbEVsZW0gPSB0ZW1wbGF0ZVNlbGVjdG9yO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IFwia2FzaW1pcl90cGwoKTogcGFyYW1ldGVyMSBpcyBub3QgYSBIdG1sRWxlbWVudFwiO1xuICAgIH1cbiAgICBsZXQgcmVuZGVyZXIgPSBuZXcgS2FzaW1pclJlbmRlcmVyKCk7XG4gICAgcmV0dXJuIHJlbmRlcmVyLnJlbmRlcih0cGxFbGVtKTtcbn1cbiIsIlxuXG5jbGFzcyBLYXNpbWlyUmVuZGVyZXIge1xuXG4gICAgY29uc3RydWN0b3IoYXR0clByZWZpeD1cIipcIikge1xuICAgICAgICB0aGlzLl9hdHRyUHJlZml4ID0gYXR0clByZWZpeFxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIGRvbW5vZGUge0hUTUxFbGVtZW50fVxuICAgICAqL1xuICAgIF9nZXRBdHRyaWJ1dGVTdHIoZG9tbm9kZSkge1xuICAgICAgICBsZXQgcmV0ID0gXCJcIjtcbiAgICAgICAgZm9yIChsZXQgYXR0ciBvZiBkb21ub2RlLmF0dHJpYnV0ZXMpXG4gICAgICAgICAgICByZXQgKz0gXCIgXCIgKyBhdHRyLm5hbWUgKyBcIj1cXFwiXCIgKyBhdHRyLnZhbHVlICsgXCJcXFwiXCI7XG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuXG5cbiAgICBfYWRkc2xhc2hlcyhzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9cXFxcL2csICdcXFxcXFxcXCcpLlxuICAgICAgICAgICAgcmVwbGFjZSgvXFx1MDAwOC9nLCAnXFxcXGInKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1xcdC9nLCAnXFxcXHQnKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1xcbi9nLCAnXFxcXG4nKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1xcZi9nLCAnXFxcXGYnKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1xcci9nLCAnXFxcXHInKS5cbiAgICAgICAgICAgIHJlcGxhY2UoLycvZywgJ1xcXFxcXCcnKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1wiL2csICdcXFxcXCInKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkb21ub2RlIHtIVE1MRWxlbWVudH1cbiAgICAgKiBAcmV0dXJuXG4gICAgICovXG4gICAgX2dldExvZ2ljKGRvbW5vZGUpIHtcbiAgICAgICAgbGV0IHJldCA9IHtvcGVuOlwiXCIsIGNsb3NlOlwiXCIsIGhhbmRsZXI6e319O1xuXG4gICAgICAgIGlmIChkb21ub2RlLmhhc0F0dHJpYnV0ZSh0aGlzLl9hdHRyUHJlZml4ICsgXCJpZlwiKSkge1xuICAgICAgICAgICAgcmV0Lm9wZW4gKz0gXCJpZihcIiArIGRvbW5vZGUuZ2V0QXR0cmlidXRlKHRoaXMuX2F0dHJQcmVmaXggKyBcImlmXCIpICsgXCIpe1wiO1xuICAgICAgICAgICAgcmV0LmNsb3NlICs9IFwifVwiO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkb21ub2RlLmhhc0F0dHJpYnV0ZSh0aGlzLl9hdHRyUHJlZml4ICsgXCJmb3JcIikpIHtcbiAgICAgICAgICAgIHJldC5vcGVuICs9IFwiZm9yKFwiICsgZG9tbm9kZS5nZXRBdHRyaWJ1dGUodGhpcy5fYXR0clByZWZpeCArIFwiZm9yXCIpICsgXCIpe1wiO1xuICAgICAgICAgICAgcmV0LmNsb3NlICs9IFwifVwiO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgYXR0ciBvZiBkb21ub2RlLmF0dHJpYnV0ZXMpIHtcbiAgICAgICAgICAgIGxldCBtYXRjaGVzID0gYXR0ci5uYW1lLm1hdGNoKC9eb24oLispLyk7XG4gICAgICAgICAgICBpZiAobWF0Y2hlcyA9PT0gbnVsbClcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIHJldC5oYW5kbGVyW2F0dHIubmFtZV0gPSBhdHRyLnZhbHVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJldDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkb21ub2RlIHtOb2RlfVxuICAgICAqIEBwYXJhbSBwYXRoIHtTdHJpbmd9XG4gICAgICogQHBhcmFtIGRlcHRoXG4gICAgICovXG4gICAgX3JlbmRlcihkb21ub2RlLCBwYXRoLCBkZXB0aCkge1xuICAgICAgICBsZXQgb3V0ID0gXCJcIjtcblxuXG4gICAgICAgIGNvbnNvbGUubG9nKGRvbW5vZGUpO1xuICAgICAgICBpZiAoZG9tbm9kZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG5cbiAgICAgICAgICAgIGxldCBsb2dpYyA9IHRoaXMuX2dldExvZ2ljKGRvbW5vZGUpO1xuICAgICAgICAgICAgbGV0IGF0dHJTdHIgPSB0aGlzLl9nZXRBdHRyaWJ1dGVTdHIoZG9tbm9kZSk7XG4gICAgICAgICAgICBsZXQgY3VyUGF0aCA9IHBhdGggKyBcIiA+IFwiICsgZG9tbm9kZS50YWdOYW1lICsgYXR0clN0cjtcbiAgICAgICAgICAgIG91dCArPSBcIlxcblwiICsgbG9naWMub3BlbjtcblxuICAgICAgICAgICAgb3V0ICs9IFwiXFxuX19kZWJ1Z19wYXRoX18gPSAnXCIgKyB0aGlzLl9hZGRzbGFzaGVzKGN1clBhdGgpICsgXCInO1wiO1xuICAgICAgICAgICAgaWYgKGRvbW5vZGUudGFnTmFtZSA9PT0gXCJTQ1JJUFRcIikge1xuICAgICAgICAgICAgICAgIG91dCArPSBcIlxcbmV2YWwoYFwiICsgZG9tbm9kZS50ZXh0Q29udGVudCArIFwiYCk7XCJcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb3V0ICs9IFwiXFxuX2VbXCIgKyBkZXB0aCArIFwiXSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ1wiICsgZG9tbm9kZS50YWdOYW1lICsgXCInKTtcIjtcblxuICAgICAgICAgICAgICAgIGZvciAobGV0IGhhbmRsZXJOYW1lIGluIGxvZ2ljLmhhbmRsZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgb3V0ICs9IFwiXFxuX2VbXCIgKyBkZXB0aCArIFwiXS5cIiArIGhhbmRsZXJOYW1lICsgXCIgPSBmdW5jdGlvbihlKXsgXCIgKyBsb2dpYy5oYW5kbGVyW2hhbmRsZXJOYW1lXSArIFwiIH07XCI7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgb3V0ICs9IFwiXFxuX2VbXCIgKyAoZGVwdGggLSAxKSArIFwiXS5hcHBlbmRDaGlsZChfZVtcIiArIGRlcHRoICsgXCJdKTtcIjtcbiAgICAgICAgICAgICAgICAvLyBvdXQgKz0gXCJcXG5fX2h0bWxfXyArPSBgPFwiICsgZG9tbm9kZS50YWdOYW1lICsgYXR0clN0ciArIFwiPmA7XCI7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgY2hpbGQgb2YgZG9tbm9kZS5jaGlsZE5vZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgIG91dCArPSB0aGlzLl9yZW5kZXIoY2hpbGQsIGN1clBhdGgsIGRlcHRoICsgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy9vdXQgKz0gXCJcXG5fX2h0bWxfXyArPSBgPC9cIiArIGRvbW5vZGUudGFnTmFtZSArIFwiPmA7XCJcbiAgICAgICAgICAgIG91dCArPSBcIlxcblwiICsgbG9naWMuY2xvc2U7XG4gICAgICAgIH0gZWxzZSBpZiAoZG9tbm9kZSBpbnN0YW5jZW9mIFRleHQpIHtcbiAgICAgICAgICAgIGxldCBjdXJQYXRoID0gcGF0aCArIFwiID4gKHRleHQpXCI7XG4gICAgICAgICAgICBvdXQgKz0gXCJcXG5fX2RlYnVnX3BhdGhfXyA9ICdcIiArIHRoaXMuX2FkZHNsYXNoZXMoY3VyUGF0aCkgKyBcIic7XCI7XG4gICAgICAgICAgICBvdXQgKz0gXCJcXG5fZVtcIiArIChkZXB0aC0xKSArXCJdLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGBcIiArIGRvbW5vZGUudGV4dENvbnRlbnQgKyBcImApKTtcIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gb3V0XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkb21ub2RlXG4gICAgICogQHJldHVybiB7S2FzaW1pclRlbXBsYXRlfVxuICAgICAqL1xuICAgIHJlbmRlcihkb21ub2RlKSB7XG4gICAgICAgIGxldCBvdXQgPSBcInZhciBfX2RlYnVnX3BhdGhfXyA9ICcocm9vdCknO1wiO1xuICAgICAgICBvdXQgKz0gXCJcXG52YXIgX2UgPSBbZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyldO1wiO1xuXG5cbiAgICAgICAgaWYgKGRvbW5vZGUgaW5zdGFuY2VvZiBIVE1MVGVtcGxhdGVFbGVtZW50KSB7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGN1ckNoaWxkIG9mIGRvbW5vZGUuY29udGVudC5jaGlsZE5vZGVzKSB7XG4gICAgICAgICAgICAgICAgb3V0ICs9IHRoaXMuX3JlbmRlcihjdXJDaGlsZCwgIFwiKHJvb3QpXCIsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb3V0ICs9IHRoaXMuX3JlbmRlcihkb21ub2RlLCAgXCIocm9vdClcIiwgMSk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIGxldCB4b3V0ID0gYFxuICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihzY29wZSl7XG4gICAgICAgICAgICAgICAgbGV0IGZucyA9IFtdO1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICR7b3V0fVxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgJ0Vycm9yIGluICcgKyBfX2RlYnVnX3BhdGhfXyArICc6ICcgKyBlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gX2VbMF07XG4gICAgICAgICAgICB9O1xuICAgICAgICBgO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKHhvdXQpO1xuICAgICAgICBsZXQgZm4gO1xuICAgICAgICBldmFsKHhvdXQpO1xuICAgICAgICByZXR1cm4gbmV3IEthc2ltaXJUZW1wbGF0ZShmbik7XG4gICAgfVxuXG59XG5cbiIsImNsYXNzIEthc2ltaXJUZW1wbGF0ZSB7XG5cbiAgICBjb25zdHJ1Y3Rvcih0cGxGbikge1xuICAgICAgICB0aGlzLl90cGxGbiA9IHRwbEZuO1xuICAgICAgICAvKipcbiAgICAgICAgICpcbiAgICAgICAgICogQHR5cGUge0hUTUxFbGVtZW50fVxuICAgICAgICAgKiBAcHJpdmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fYmluZCA9IG51bGw7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZG9tU2VsZWN0b3Ige3N0cmluZ3xIVE1MRWxlbWVudH1cbiAgICAgKiBAcmV0dXJuIEthc2ltaXJUZW1wbGF0ZVxuICAgICAqL1xuICAgIGJpbmQoZG9tU2VsZWN0b3IpIHtcbiAgICAgICAgbGV0IG5vZGUgPSBudWxsO1xuICAgICAgICBpZiAodHlwZW9mIGRvbVNlbGVjdG9yID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihkb21TZWxlY3Rvcik7XG4gICAgICAgICAgICBpZiAobm9kZSA9PT0gbnVsbClcbiAgICAgICAgICAgICAgICB0aHJvdyBcImJpbmQoKTogY2FuJ3QgZmluZCBlbGVtZW50ICdcIiArIGRvbVNlbGVjdG9yICsgXCInXCI7XG4gICAgICAgIH0gZWxzZSBpZiAoZG9tU2VsZWN0b3IgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgbm9kZSA9IGRvbVNlbGVjdG9yO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgXCJiaW5kKCk6IHBhcmFtZXRlcjEgaXMgbm90IGEgSHRtbEVsZW1lbnRcIjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9iaW5kID0gbm9kZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqIEByZXR1cm4ge0thc2ltaXJUZW1wbGF0ZX1cbiAgICAgKi9cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5fdHBsRm4oc2NvcGUpKTtcbiAgICAgICAgdGhpcy5fYmluZC5yZXBsYWNlQ2hpbGQodGhpcy5fdHBsRm4oc2NvcGUpLCB0aGlzLl9iaW5kLmZpcnN0Q2hpbGQpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqIEByZXR1cm4ge0thc2ltaXJUZW1wbGF0ZX1cbiAgICAgKi9cbiAgICBvYnNlcnZlKHNjb3BlKSB7XG4gICAgICAgIHRoaXMucmVuZGVyKHNjb3BlKTtcbiAgICAgICAgd2luZG93LnNldEludGVydmFsKGUgPT4ge1xuICAgICAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KHNjb3BlKSAhPT0gdGhpcy5fb2JzZXJ2ZWRMYXN0VmFsdWUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9vYnNlcnZlZExhc3RWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KHNjb3BlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcihzY29wZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIDIwMCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxufVxuXG4iXX0=

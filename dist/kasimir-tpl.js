/**
 * Infracamp's Kasimir Templates
 *
 * A no-dependency render on request
 *
 * @author Matthias Leuffen <m@tth.es>
 */


/**
 *
 * @param templateSelector
 * @return {KasimirTemplate}
 */
function kasimir_tpl(templateSelector) {
    let tplElem = null;
    if (typeof templateSelector === "string") {
        tplElem = document.querySelector(templateSelector);
        if (tplElem === null)
            throw "kasimir_tpl(): can't find element '" + templateSelector + "'";
    } else if (templateSelector instanceof HTMLElement) {
        tplElem = templateSelector;
    } else {
        throw "kasimir_tpl(): parameter1 is not a HtmlElement";
    }
    let renderer = new KasimirRenderer();
    return renderer.render(tplElem);
}




class KasimirRenderer {

    constructor(attrPrefix="*") {
        this._attrPrefix = attrPrefix
    }

    /**
     *
     * @param domnode {HTMLElement}
     */
    _getAttributeStr(domnode) {
        let ret = "";
        for (let attr of domnode.attributes)
            ret += " " + attr.name + "=\"" + attr.value + "\"";
        return ret;
    }


    _addslashes(string) {
        return string.replace(/\\/g, '\\\\').
            replace(/\u0008/g, '\\b').
            replace(/\t/g, '\\t').
            replace(/\n/g, '\\n').
            replace(/\f/g, '\\f').
            replace(/\r/g, '\\r').
            replace(/'/g, '\\\'').
            replace(/"/g, '\\"');
    }

    /**
     *
     * @param domnode {HTMLElement}
     * @return
     */
    _getLogic(domnode) {
        let ret = {open:"", close:"", handler:{}};

        if (domnode.hasAttribute(this._attrPrefix + "if")) {
            ret.open += "if(" + domnode.getAttribute(this._attrPrefix + "if") + "){";
            ret.close += "}";
        }
        if (domnode.hasAttribute(this._attrPrefix + "for")) {
            ret.open += "for(" + domnode.getAttribute(this._attrPrefix + "for") + "){";
            ret.close += "}";
        }

        for (let attr of domnode.attributes) {
            let matches = attr.name.match(/^on(.+)/);
            if (matches === null)
                continue;
            ret.handler[attr.name] = attr.value;
        }

        return ret;
    }

    /**
     *
     * @param domnode {Node}
     * @param path {String}
     * @param depth
     */
    _render(domnode, path, depth) {
        let out = "";

        if (domnode instanceof HTMLElement) {

            let logic = this._getLogic(domnode);
            let attrStr = this._getAttributeStr(domnode);
            let curPath = path + " > " + domnode.tagName + attrStr;
            out += "\n" + logic.open;

            out += "\n__debug_path__ = '" + this._addslashes(curPath) + "';";
            if (domnode.tagName === "SCRIPT") {
                out += "\neval(`" + domnode.textContent + "`);"
            } else {
                out += "\n_e[" + depth + "] = document.createElement('" + domnode.tagName + "');";

                for (let attr of domnode.attributes) {
                    if (attr.name.startsWith(this._attrPrefix))
                        continue;
                    out += "\n_e[" + depth + "].setAttribute('" + attr.name + "', `" + attr.value + "`);";
                }
                for (let handlerName in logic.handler) {
                    out += "\n_e[" + depth + "]." + handlerName + " = function(e){ " + logic.handler[handlerName] + " };";
                }

                out += "\n_e[" + (depth - 1) + "].appendChild(_e[" + depth + "]);";
                // out += "\n__html__ += `<" + domnode.tagName + attrStr + ">`;";
                for (let child of domnode.childNodes) {
                    out += this._render(child, curPath, depth + 1);
                }
            }
            //out += "\n__html__ += `</" + domnode.tagName + ">`;"
            out += "\n" + logic.close;
        } else if (domnode instanceof Text) {
            let curPath = path + " > (text)";
            out += "\n__debug_path__ = '" + this._addslashes(curPath) + "';";
            out += "\n_e[" + (depth-1) +"].appendChild(document.createTextNode(`" + domnode.textContent + "`));";
        }
        return out
    }


    /**
     *
     * @param domnode
     * @return {KasimirTemplate}
     */
    render(domnode) {
        let out = "var __debug_path__ = '(root)';";
        out += "\nvar _e = [document.createElement('div')];";


        if (domnode instanceof HTMLTemplateElement) {

            for (let curChild of domnode.content.childNodes) {
                out += this._render(curChild,  "(root)", 1);
            }
        } else {
            out += this._render(domnode,  "(root)", 1);
        }


        let xout = `
            fn = function(scope){
                let fns = [];
                try {
                    ${out}
                } catch (e) {
                    throw 'Error in ' + __debug_path__ + ': ' + e;
                }
                return _e[0];
            };
        `;

        console.log(xout);
        let fn ;
        eval(xout);
        return new KasimirTemplate(fn);
    }

}


class KasimirTemplate {

    constructor(tplFn) {
        this._tplFn = tplFn;
        /**
         *
         * @type {HTMLElement}
         * @private
         */
        this._bind = null;
    }

    /**
     *
     * @param domSelector {string|HTMLElement}
     * @return KasimirTemplate
     */
    renderIn(domSelector) {
        let node = null;
        if (typeof domSelector === "string") {
            node = document.querySelector(domSelector);
            if (node === null)
                throw "bind(): can't find element '" + domSelector + "'";
        } else if (domSelector instanceof HTMLElement) {
            node = domSelector;
        } else {
            throw "bind(): parameter1 is not a HtmlElement";
        }
        this._bind = node;
        return this;
    }


    /**
     *
     * @param scope
     * @return {KasimirTemplate}
     */
    render(scope) {
        console.log(this._tplFn(scope));
        this._bind.replaceChild(this._tplFn(scope), this._bind.firstChild);
        return this;
    }

    /**
     *
     * @param scope
     * @return {KasimirTemplate}
     */
    observe(scope) {
        this.render(scope);
        window.setInterval(e => {
            if (JSON.stringify(scope) !== this._observedLastValue) {
                this._observedLastValue = JSON.stringify(scope);
                this.render(scope);
            }
        }, 200);
        return this;
    }

}





class KmTplElem extends HTMLElement {

    constructor() {
        super();

        this._attrs = {
            bind: null,
            observe: null,
        };
        this._config = {
        };

        /**
         *
         * @type {KasimirTemplate}
         */
        this.tpl = null;
    }


    static get observedAttributes() { return ["bind", "observe"]; }

    attributeChangedCallback(name, oldValue, newValue) {
        this._attrs[name] = newValue;
    }

    connectedCallback() {
        window.addEventListener("load", () => {
            console.log("load", window["data"]);
            let template = this.querySelector("template");
            if (template === null) {
                console.error("<km-tpl> has no template child.", this);
                throw "<km-tpl> requires <template> child.";
            }

            this.tpl = kasimir_tpl(template);
            this.removeChild(template);
            this.tpl.renderIn(this);

            if (this._attrs.bind !== null) {
                this.tpl.bind(window[this._attrs.bind]);
            }
            if (this._attrs.observe) {
                let observed = window[this._attrs.observe];
                console.log(observed);
                if (typeof observed !== "object")
                    throw "observed variable window['" + this._attrs.observe + "'] is typeof " + (typeof observed) + " but object required";
                this.tpl.observe(observed);
            }
        });
    }

    disconnectCallback() {

    }

}

customElements.define("km-tpl", KmTplElem);

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZ1bmN0aW9ucy5qcyIsImthc2ltaXItcmVuZGVyZXIuanMiLCJrYXNpbWlyLXRlbXBsYXRlLmpzIiwia20tdHBsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbEpBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJrYXNpbWlyLXRwbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuXG4vKipcbiAqXG4gKiBAcGFyYW0gdGVtcGxhdGVTZWxlY3RvclxuICogQHJldHVybiB7S2FzaW1pclRlbXBsYXRlfVxuICovXG5mdW5jdGlvbiBrYXNpbWlyX3RwbCh0ZW1wbGF0ZVNlbGVjdG9yKSB7XG4gICAgbGV0IHRwbEVsZW0gPSBudWxsO1xuICAgIGlmICh0eXBlb2YgdGVtcGxhdGVTZWxlY3RvciA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICB0cGxFbGVtID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0ZW1wbGF0ZVNlbGVjdG9yKTtcbiAgICAgICAgaWYgKHRwbEVsZW0gPT09IG51bGwpXG4gICAgICAgICAgICB0aHJvdyBcImthc2ltaXJfdHBsKCk6IGNhbid0IGZpbmQgZWxlbWVudCAnXCIgKyB0ZW1wbGF0ZVNlbGVjdG9yICsgXCInXCI7XG4gICAgfSBlbHNlIGlmICh0ZW1wbGF0ZVNlbGVjdG9yIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgdHBsRWxlbSA9IHRlbXBsYXRlU2VsZWN0b3I7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgXCJrYXNpbWlyX3RwbCgpOiBwYXJhbWV0ZXIxIGlzIG5vdCBhIEh0bWxFbGVtZW50XCI7XG4gICAgfVxuICAgIGxldCByZW5kZXJlciA9IG5ldyBLYXNpbWlyUmVuZGVyZXIoKTtcbiAgICByZXR1cm4gcmVuZGVyZXIucmVuZGVyKHRwbEVsZW0pO1xufVxuXG4iLCJcblxuY2xhc3MgS2FzaW1pclJlbmRlcmVyIHtcblxuICAgIGNvbnN0cnVjdG9yKGF0dHJQcmVmaXg9XCIqXCIpIHtcbiAgICAgICAgdGhpcy5fYXR0clByZWZpeCA9IGF0dHJQcmVmaXhcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkb21ub2RlIHtIVE1MRWxlbWVudH1cbiAgICAgKi9cbiAgICBfZ2V0QXR0cmlidXRlU3RyKGRvbW5vZGUpIHtcbiAgICAgICAgbGV0IHJldCA9IFwiXCI7XG4gICAgICAgIGZvciAobGV0IGF0dHIgb2YgZG9tbm9kZS5hdHRyaWJ1dGVzKVxuICAgICAgICAgICAgcmV0ICs9IFwiIFwiICsgYXR0ci5uYW1lICsgXCI9XFxcIlwiICsgYXR0ci52YWx1ZSArIFwiXFxcIlwiO1xuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cblxuXG4gICAgX2FkZHNsYXNoZXMoc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZSgvXFxcXC9nLCAnXFxcXFxcXFwnKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1xcdTAwMDgvZywgJ1xcXFxiJykuXG4gICAgICAgICAgICByZXBsYWNlKC9cXHQvZywgJ1xcXFx0JykuXG4gICAgICAgICAgICByZXBsYWNlKC9cXG4vZywgJ1xcXFxuJykuXG4gICAgICAgICAgICByZXBsYWNlKC9cXGYvZywgJ1xcXFxmJykuXG4gICAgICAgICAgICByZXBsYWNlKC9cXHIvZywgJ1xcXFxyJykuXG4gICAgICAgICAgICByZXBsYWNlKC8nL2csICdcXFxcXFwnJykuXG4gICAgICAgICAgICByZXBsYWNlKC9cIi9nLCAnXFxcXFwiJyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZG9tbm9kZSB7SFRNTEVsZW1lbnR9XG4gICAgICogQHJldHVyblxuICAgICAqL1xuICAgIF9nZXRMb2dpYyhkb21ub2RlKSB7XG4gICAgICAgIGxldCByZXQgPSB7b3BlbjpcIlwiLCBjbG9zZTpcIlwiLCBoYW5kbGVyOnt9fTtcblxuICAgICAgICBpZiAoZG9tbm9kZS5oYXNBdHRyaWJ1dGUodGhpcy5fYXR0clByZWZpeCArIFwiaWZcIikpIHtcbiAgICAgICAgICAgIHJldC5vcGVuICs9IFwiaWYoXCIgKyBkb21ub2RlLmdldEF0dHJpYnV0ZSh0aGlzLl9hdHRyUHJlZml4ICsgXCJpZlwiKSArIFwiKXtcIjtcbiAgICAgICAgICAgIHJldC5jbG9zZSArPSBcIn1cIjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZG9tbm9kZS5oYXNBdHRyaWJ1dGUodGhpcy5fYXR0clByZWZpeCArIFwiZm9yXCIpKSB7XG4gICAgICAgICAgICByZXQub3BlbiArPSBcImZvcihcIiArIGRvbW5vZGUuZ2V0QXR0cmlidXRlKHRoaXMuX2F0dHJQcmVmaXggKyBcImZvclwiKSArIFwiKXtcIjtcbiAgICAgICAgICAgIHJldC5jbG9zZSArPSBcIn1cIjtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAobGV0IGF0dHIgb2YgZG9tbm9kZS5hdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICBsZXQgbWF0Y2hlcyA9IGF0dHIubmFtZS5tYXRjaCgvXm9uKC4rKS8pO1xuICAgICAgICAgICAgaWYgKG1hdGNoZXMgPT09IG51bGwpXG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICByZXQuaGFuZGxlclthdHRyLm5hbWVdID0gYXR0ci52YWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZG9tbm9kZSB7Tm9kZX1cbiAgICAgKiBAcGFyYW0gcGF0aCB7U3RyaW5nfVxuICAgICAqIEBwYXJhbSBkZXB0aFxuICAgICAqL1xuICAgIF9yZW5kZXIoZG9tbm9kZSwgcGF0aCwgZGVwdGgpIHtcbiAgICAgICAgbGV0IG91dCA9IFwiXCI7XG5cbiAgICAgICAgaWYgKGRvbW5vZGUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgICAgICBsZXQgbG9naWMgPSB0aGlzLl9nZXRMb2dpYyhkb21ub2RlKTtcbiAgICAgICAgICAgIGxldCBhdHRyU3RyID0gdGhpcy5fZ2V0QXR0cmlidXRlU3RyKGRvbW5vZGUpO1xuICAgICAgICAgICAgbGV0IGN1clBhdGggPSBwYXRoICsgXCIgPiBcIiArIGRvbW5vZGUudGFnTmFtZSArIGF0dHJTdHI7XG4gICAgICAgICAgICBvdXQgKz0gXCJcXG5cIiArIGxvZ2ljLm9wZW47XG5cbiAgICAgICAgICAgIG91dCArPSBcIlxcbl9fZGVidWdfcGF0aF9fID0gJ1wiICsgdGhpcy5fYWRkc2xhc2hlcyhjdXJQYXRoKSArIFwiJztcIjtcbiAgICAgICAgICAgIGlmIChkb21ub2RlLnRhZ05hbWUgPT09IFwiU0NSSVBUXCIpIHtcbiAgICAgICAgICAgICAgICBvdXQgKz0gXCJcXG5ldmFsKGBcIiArIGRvbW5vZGUudGV4dENvbnRlbnQgKyBcImApO1wiXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG91dCArPSBcIlxcbl9lW1wiICsgZGVwdGggKyBcIl0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdcIiArIGRvbW5vZGUudGFnTmFtZSArIFwiJyk7XCI7XG5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBhdHRyIG9mIGRvbW5vZGUuYXR0cmlidXRlcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ci5uYW1lLnN0YXJ0c1dpdGgodGhpcy5fYXR0clByZWZpeCkpXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgb3V0ICs9IFwiXFxuX2VbXCIgKyBkZXB0aCArIFwiXS5zZXRBdHRyaWJ1dGUoJ1wiICsgYXR0ci5uYW1lICsgXCInLCBgXCIgKyBhdHRyLnZhbHVlICsgXCJgKTtcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaGFuZGxlck5hbWUgaW4gbG9naWMuaGFuZGxlcikge1xuICAgICAgICAgICAgICAgICAgICBvdXQgKz0gXCJcXG5fZVtcIiArIGRlcHRoICsgXCJdLlwiICsgaGFuZGxlck5hbWUgKyBcIiA9IGZ1bmN0aW9uKGUpeyBcIiArIGxvZ2ljLmhhbmRsZXJbaGFuZGxlck5hbWVdICsgXCIgfTtcIjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBvdXQgKz0gXCJcXG5fZVtcIiArIChkZXB0aCAtIDEpICsgXCJdLmFwcGVuZENoaWxkKF9lW1wiICsgZGVwdGggKyBcIl0pO1wiO1xuICAgICAgICAgICAgICAgIC8vIG91dCArPSBcIlxcbl9faHRtbF9fICs9IGA8XCIgKyBkb21ub2RlLnRhZ05hbWUgKyBhdHRyU3RyICsgXCI+YDtcIjtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBjaGlsZCBvZiBkb21ub2RlLmNoaWxkTm9kZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgb3V0ICs9IHRoaXMuX3JlbmRlcihjaGlsZCwgY3VyUGF0aCwgZGVwdGggKyAxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvL291dCArPSBcIlxcbl9faHRtbF9fICs9IGA8L1wiICsgZG9tbm9kZS50YWdOYW1lICsgXCI+YDtcIlxuICAgICAgICAgICAgb3V0ICs9IFwiXFxuXCIgKyBsb2dpYy5jbG9zZTtcbiAgICAgICAgfSBlbHNlIGlmIChkb21ub2RlIGluc3RhbmNlb2YgVGV4dCkge1xuICAgICAgICAgICAgbGV0IGN1clBhdGggPSBwYXRoICsgXCIgPiAodGV4dClcIjtcbiAgICAgICAgICAgIG91dCArPSBcIlxcbl9fZGVidWdfcGF0aF9fID0gJ1wiICsgdGhpcy5fYWRkc2xhc2hlcyhjdXJQYXRoKSArIFwiJztcIjtcbiAgICAgICAgICAgIG91dCArPSBcIlxcbl9lW1wiICsgKGRlcHRoLTEpICtcIl0uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoYFwiICsgZG9tbm9kZS50ZXh0Q29udGVudCArIFwiYCkpO1wiO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvdXRcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIGRvbW5vZGVcbiAgICAgKiBAcmV0dXJuIHtLYXNpbWlyVGVtcGxhdGV9XG4gICAgICovXG4gICAgcmVuZGVyKGRvbW5vZGUpIHtcbiAgICAgICAgbGV0IG91dCA9IFwidmFyIF9fZGVidWdfcGF0aF9fID0gJyhyb290KSc7XCI7XG4gICAgICAgIG91dCArPSBcIlxcbnZhciBfZSA9IFtkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKV07XCI7XG5cblxuICAgICAgICBpZiAoZG9tbm9kZSBpbnN0YW5jZW9mIEhUTUxUZW1wbGF0ZUVsZW1lbnQpIHtcblxuICAgICAgICAgICAgZm9yIChsZXQgY3VyQ2hpbGQgb2YgZG9tbm9kZS5jb250ZW50LmNoaWxkTm9kZXMpIHtcbiAgICAgICAgICAgICAgICBvdXQgKz0gdGhpcy5fcmVuZGVyKGN1ckNoaWxkLCAgXCIocm9vdClcIiwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvdXQgKz0gdGhpcy5fcmVuZGVyKGRvbW5vZGUsICBcIihyb290KVwiLCAxKTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgbGV0IHhvdXQgPSBgXG4gICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKHNjb3BlKXtcbiAgICAgICAgICAgICAgICBsZXQgZm5zID0gW107XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgJHtvdXR9XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyAnRXJyb3IgaW4gJyArIF9fZGVidWdfcGF0aF9fICsgJzogJyArIGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBfZVswXTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIGA7XG5cbiAgICAgICAgY29uc29sZS5sb2coeG91dCk7XG4gICAgICAgIGxldCBmbiA7XG4gICAgICAgIGV2YWwoeG91dCk7XG4gICAgICAgIHJldHVybiBuZXcgS2FzaW1pclRlbXBsYXRlKGZuKTtcbiAgICB9XG5cbn1cblxuIiwiY2xhc3MgS2FzaW1pclRlbXBsYXRlIHtcblxuICAgIGNvbnN0cnVjdG9yKHRwbEZuKSB7XG4gICAgICAgIHRoaXMuX3RwbEZuID0gdHBsRm47XG4gICAgICAgIC8qKlxuICAgICAgICAgKlxuICAgICAgICAgKiBAdHlwZSB7SFRNTEVsZW1lbnR9XG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9iaW5kID0gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkb21TZWxlY3RvciB7c3RyaW5nfEhUTUxFbGVtZW50fVxuICAgICAqIEByZXR1cm4gS2FzaW1pclRlbXBsYXRlXG4gICAgICovXG4gICAgcmVuZGVySW4oZG9tU2VsZWN0b3IpIHtcbiAgICAgICAgbGV0IG5vZGUgPSBudWxsO1xuICAgICAgICBpZiAodHlwZW9mIGRvbVNlbGVjdG9yID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihkb21TZWxlY3Rvcik7XG4gICAgICAgICAgICBpZiAobm9kZSA9PT0gbnVsbClcbiAgICAgICAgICAgICAgICB0aHJvdyBcImJpbmQoKTogY2FuJ3QgZmluZCBlbGVtZW50ICdcIiArIGRvbVNlbGVjdG9yICsgXCInXCI7XG4gICAgICAgIH0gZWxzZSBpZiAoZG9tU2VsZWN0b3IgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgbm9kZSA9IGRvbVNlbGVjdG9yO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgXCJiaW5kKCk6IHBhcmFtZXRlcjEgaXMgbm90IGEgSHRtbEVsZW1lbnRcIjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9iaW5kID0gbm9kZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqIEByZXR1cm4ge0thc2ltaXJUZW1wbGF0ZX1cbiAgICAgKi9cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5fdHBsRm4oc2NvcGUpKTtcbiAgICAgICAgdGhpcy5fYmluZC5yZXBsYWNlQ2hpbGQodGhpcy5fdHBsRm4oc2NvcGUpLCB0aGlzLl9iaW5kLmZpcnN0Q2hpbGQpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqIEByZXR1cm4ge0thc2ltaXJUZW1wbGF0ZX1cbiAgICAgKi9cbiAgICBvYnNlcnZlKHNjb3BlKSB7XG4gICAgICAgIHRoaXMucmVuZGVyKHNjb3BlKTtcbiAgICAgICAgd2luZG93LnNldEludGVydmFsKGUgPT4ge1xuICAgICAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KHNjb3BlKSAhPT0gdGhpcy5fb2JzZXJ2ZWRMYXN0VmFsdWUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9vYnNlcnZlZExhc3RWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KHNjb3BlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcihzY29wZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIDIwMCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxufVxuXG4iLCJcblxuXG5jbGFzcyBLbVRwbEVsZW0gZXh0ZW5kcyBIVE1MRWxlbWVudCB7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLl9hdHRycyA9IHtcbiAgICAgICAgICAgIGJpbmQ6IG51bGwsXG4gICAgICAgICAgICBvYnNlcnZlOiBudWxsLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLl9jb25maWcgPSB7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqXG4gICAgICAgICAqIEB0eXBlIHtLYXNpbWlyVGVtcGxhdGV9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnRwbCA9IG51bGw7XG4gICAgfVxuXG5cbiAgICBzdGF0aWMgZ2V0IG9ic2VydmVkQXR0cmlidXRlcygpIHsgcmV0dXJuIFtcImJpbmRcIiwgXCJvYnNlcnZlXCJdOyB9XG5cbiAgICBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgICAgIHRoaXMuX2F0dHJzW25hbWVdID0gbmV3VmFsdWU7XG4gICAgfVxuXG4gICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibG9hZFwiLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImxvYWRcIiwgd2luZG93W1wiZGF0YVwiXSk7XG4gICAgICAgICAgICBsZXQgdGVtcGxhdGUgPSB0aGlzLnF1ZXJ5U2VsZWN0b3IoXCJ0ZW1wbGF0ZVwiKTtcbiAgICAgICAgICAgIGlmICh0ZW1wbGF0ZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCI8a20tdHBsPiBoYXMgbm8gdGVtcGxhdGUgY2hpbGQuXCIsIHRoaXMpO1xuICAgICAgICAgICAgICAgIHRocm93IFwiPGttLXRwbD4gcmVxdWlyZXMgPHRlbXBsYXRlPiBjaGlsZC5cIjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy50cGwgPSBrYXNpbWlyX3RwbCh0ZW1wbGF0ZSk7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNoaWxkKHRlbXBsYXRlKTtcbiAgICAgICAgICAgIHRoaXMudHBsLnJlbmRlckluKHRoaXMpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5fYXR0cnMuYmluZCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHRoaXMudHBsLmJpbmQod2luZG93W3RoaXMuX2F0dHJzLmJpbmRdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLl9hdHRycy5vYnNlcnZlKSB7XG4gICAgICAgICAgICAgICAgbGV0IG9ic2VydmVkID0gd2luZG93W3RoaXMuX2F0dHJzLm9ic2VydmVdO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG9ic2VydmVkKTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9ic2VydmVkICE9PSBcIm9iamVjdFwiKVxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBcIm9ic2VydmVkIHZhcmlhYmxlIHdpbmRvd1snXCIgKyB0aGlzLl9hdHRycy5vYnNlcnZlICsgXCInXSBpcyB0eXBlb2YgXCIgKyAodHlwZW9mIG9ic2VydmVkKSArIFwiIGJ1dCBvYmplY3QgcmVxdWlyZWRcIjtcbiAgICAgICAgICAgICAgICB0aGlzLnRwbC5vYnNlcnZlKG9ic2VydmVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZGlzY29ubmVjdENhbGxiYWNrKCkge1xuXG4gICAgfVxuXG59XG5cbmN1c3RvbUVsZW1lbnRzLmRlZmluZShcImttLXRwbFwiLCBLbVRwbEVsZW0pO1xuXG4iXX0=
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZ1bmN0aW9ucy5qcyIsImthc2ltaXItcmVuZGVyZXIuanMiLCJrYXNpbWlyLXRlbXBsYXRlLmpzIiwia20tdHBsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbEpBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlEQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJrYXNpbWlyLXRwbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuXG4vKipcbiAqXG4gKiBAcGFyYW0gdGVtcGxhdGVTZWxlY3RvclxuICogQHJldHVybiB7S2FzaW1pclRlbXBsYXRlfVxuICovXG5mdW5jdGlvbiBrYXNpbWlyX3RwbCh0ZW1wbGF0ZVNlbGVjdG9yKSB7XG4gICAgbGV0IHRwbEVsZW0gPSBudWxsO1xuICAgIGlmICh0eXBlb2YgdGVtcGxhdGVTZWxlY3RvciA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICB0cGxFbGVtID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0ZW1wbGF0ZVNlbGVjdG9yKTtcbiAgICAgICAgaWYgKHRwbEVsZW0gPT09IG51bGwpXG4gICAgICAgICAgICB0aHJvdyBcImthc2ltaXJfdHBsKCk6IGNhbid0IGZpbmQgZWxlbWVudCAnXCIgKyB0ZW1wbGF0ZVNlbGVjdG9yICsgXCInXCI7XG4gICAgfSBlbHNlIGlmICh0ZW1wbGF0ZVNlbGVjdG9yIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgdHBsRWxlbSA9IHRlbXBsYXRlU2VsZWN0b3I7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgXCJrYXNpbWlyX3RwbCgpOiBwYXJhbWV0ZXIxIGlzIG5vdCBhIEh0bWxFbGVtZW50XCI7XG4gICAgfVxuICAgIGxldCByZW5kZXJlciA9IG5ldyBLYXNpbWlyUmVuZGVyZXIoKTtcbiAgICByZXR1cm4gcmVuZGVyZXIucmVuZGVyKHRwbEVsZW0pO1xufVxuXG4iLCJcblxuY2xhc3MgS2FzaW1pclJlbmRlcmVyIHtcblxuICAgIGNvbnN0cnVjdG9yKGF0dHJQcmVmaXg9XCIqXCIpIHtcbiAgICAgICAgdGhpcy5fYXR0clByZWZpeCA9IGF0dHJQcmVmaXhcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkb21ub2RlIHtIVE1MRWxlbWVudH1cbiAgICAgKi9cbiAgICBfZ2V0QXR0cmlidXRlU3RyKGRvbW5vZGUpIHtcbiAgICAgICAgbGV0IHJldCA9IFwiXCI7XG4gICAgICAgIGZvciAobGV0IGF0dHIgb2YgZG9tbm9kZS5hdHRyaWJ1dGVzKVxuICAgICAgICAgICAgcmV0ICs9IFwiIFwiICsgYXR0ci5uYW1lICsgXCI9XFxcIlwiICsgYXR0ci52YWx1ZSArIFwiXFxcIlwiO1xuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cblxuXG4gICAgX2FkZHNsYXNoZXMoc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZSgvXFxcXC9nLCAnXFxcXFxcXFwnKS5cbiAgICAgICAgICAgIHJlcGxhY2UoL1xcdTAwMDgvZywgJ1xcXFxiJykuXG4gICAgICAgICAgICByZXBsYWNlKC9cXHQvZywgJ1xcXFx0JykuXG4gICAgICAgICAgICByZXBsYWNlKC9cXG4vZywgJ1xcXFxuJykuXG4gICAgICAgICAgICByZXBsYWNlKC9cXGYvZywgJ1xcXFxmJykuXG4gICAgICAgICAgICByZXBsYWNlKC9cXHIvZywgJ1xcXFxyJykuXG4gICAgICAgICAgICByZXBsYWNlKC8nL2csICdcXFxcXFwnJykuXG4gICAgICAgICAgICByZXBsYWNlKC9cIi9nLCAnXFxcXFwiJyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZG9tbm9kZSB7SFRNTEVsZW1lbnR9XG4gICAgICogQHJldHVyblxuICAgICAqL1xuICAgIF9nZXRMb2dpYyhkb21ub2RlKSB7XG4gICAgICAgIGxldCByZXQgPSB7b3BlbjpcIlwiLCBjbG9zZTpcIlwiLCBoYW5kbGVyOnt9fTtcblxuICAgICAgICBpZiAoZG9tbm9kZS5oYXNBdHRyaWJ1dGUodGhpcy5fYXR0clByZWZpeCArIFwiaWZcIikpIHtcbiAgICAgICAgICAgIHJldC5vcGVuICs9IFwiaWYoXCIgKyBkb21ub2RlLmdldEF0dHJpYnV0ZSh0aGlzLl9hdHRyUHJlZml4ICsgXCJpZlwiKSArIFwiKXtcIjtcbiAgICAgICAgICAgIHJldC5jbG9zZSArPSBcIn1cIjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZG9tbm9kZS5oYXNBdHRyaWJ1dGUodGhpcy5fYXR0clByZWZpeCArIFwiZm9yXCIpKSB7XG4gICAgICAgICAgICByZXQub3BlbiArPSBcImZvcihcIiArIGRvbW5vZGUuZ2V0QXR0cmlidXRlKHRoaXMuX2F0dHJQcmVmaXggKyBcImZvclwiKSArIFwiKXtcIjtcbiAgICAgICAgICAgIHJldC5jbG9zZSArPSBcIn1cIjtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAobGV0IGF0dHIgb2YgZG9tbm9kZS5hdHRyaWJ1dGVzKSB7XG4gICAgICAgICAgICBsZXQgbWF0Y2hlcyA9IGF0dHIubmFtZS5tYXRjaCgvXm9uKC4rKS8pO1xuICAgICAgICAgICAgaWYgKG1hdGNoZXMgPT09IG51bGwpXG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICByZXQuaGFuZGxlclthdHRyLm5hbWVdID0gYXR0ci52YWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZG9tbm9kZSB7Tm9kZX1cbiAgICAgKiBAcGFyYW0gcGF0aCB7U3RyaW5nfVxuICAgICAqIEBwYXJhbSBkZXB0aFxuICAgICAqL1xuICAgIF9yZW5kZXIoZG9tbm9kZSwgcGF0aCwgZGVwdGgpIHtcbiAgICAgICAgbGV0IG91dCA9IFwiXCI7XG5cbiAgICAgICAgaWYgKGRvbW5vZGUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuXG4gICAgICAgICAgICBsZXQgbG9naWMgPSB0aGlzLl9nZXRMb2dpYyhkb21ub2RlKTtcbiAgICAgICAgICAgIGxldCBhdHRyU3RyID0gdGhpcy5fZ2V0QXR0cmlidXRlU3RyKGRvbW5vZGUpO1xuICAgICAgICAgICAgbGV0IGN1clBhdGggPSBwYXRoICsgXCIgPiBcIiArIGRvbW5vZGUudGFnTmFtZSArIGF0dHJTdHI7XG4gICAgICAgICAgICBvdXQgKz0gXCJcXG5cIiArIGxvZ2ljLm9wZW47XG5cbiAgICAgICAgICAgIG91dCArPSBcIlxcbl9fZGVidWdfcGF0aF9fID0gJ1wiICsgdGhpcy5fYWRkc2xhc2hlcyhjdXJQYXRoKSArIFwiJztcIjtcbiAgICAgICAgICAgIGlmIChkb21ub2RlLnRhZ05hbWUgPT09IFwiU0NSSVBUXCIpIHtcbiAgICAgICAgICAgICAgICBvdXQgKz0gXCJcXG5ldmFsKGBcIiArIGRvbW5vZGUudGV4dENvbnRlbnQgKyBcImApO1wiXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG91dCArPSBcIlxcbl9lW1wiICsgZGVwdGggKyBcIl0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdcIiArIGRvbW5vZGUudGFnTmFtZSArIFwiJyk7XCI7XG5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBhdHRyIG9mIGRvbW5vZGUuYXR0cmlidXRlcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXR0ci5uYW1lLnN0YXJ0c1dpdGgodGhpcy5fYXR0clByZWZpeCkpXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgb3V0ICs9IFwiXFxuX2VbXCIgKyBkZXB0aCArIFwiXS5zZXRBdHRyaWJ1dGUoJ1wiICsgYXR0ci5uYW1lICsgXCInLCBgXCIgKyBhdHRyLnZhbHVlICsgXCJgKTtcIjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaGFuZGxlck5hbWUgaW4gbG9naWMuaGFuZGxlcikge1xuICAgICAgICAgICAgICAgICAgICBvdXQgKz0gXCJcXG5fZVtcIiArIGRlcHRoICsgXCJdLlwiICsgaGFuZGxlck5hbWUgKyBcIiA9IGZ1bmN0aW9uKGUpeyBcIiArIGxvZ2ljLmhhbmRsZXJbaGFuZGxlck5hbWVdICsgXCIgfTtcIjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBvdXQgKz0gXCJcXG5fZVtcIiArIChkZXB0aCAtIDEpICsgXCJdLmFwcGVuZENoaWxkKF9lW1wiICsgZGVwdGggKyBcIl0pO1wiO1xuICAgICAgICAgICAgICAgIC8vIG91dCArPSBcIlxcbl9faHRtbF9fICs9IGA8XCIgKyBkb21ub2RlLnRhZ05hbWUgKyBhdHRyU3RyICsgXCI+YDtcIjtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBjaGlsZCBvZiBkb21ub2RlLmNoaWxkTm9kZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgb3V0ICs9IHRoaXMuX3JlbmRlcihjaGlsZCwgY3VyUGF0aCwgZGVwdGggKyAxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvL291dCArPSBcIlxcbl9faHRtbF9fICs9IGA8L1wiICsgZG9tbm9kZS50YWdOYW1lICsgXCI+YDtcIlxuICAgICAgICAgICAgb3V0ICs9IFwiXFxuXCIgKyBsb2dpYy5jbG9zZTtcbiAgICAgICAgfSBlbHNlIGlmIChkb21ub2RlIGluc3RhbmNlb2YgVGV4dCkge1xuICAgICAgICAgICAgbGV0IGN1clBhdGggPSBwYXRoICsgXCIgPiAodGV4dClcIjtcbiAgICAgICAgICAgIG91dCArPSBcIlxcbl9fZGVidWdfcGF0aF9fID0gJ1wiICsgdGhpcy5fYWRkc2xhc2hlcyhjdXJQYXRoKSArIFwiJztcIjtcbiAgICAgICAgICAgIG91dCArPSBcIlxcbl9lW1wiICsgKGRlcHRoLTEpICtcIl0uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoYFwiICsgZG9tbm9kZS50ZXh0Q29udGVudCArIFwiYCkpO1wiO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBvdXRcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIGRvbW5vZGVcbiAgICAgKiBAcmV0dXJuIHtLYXNpbWlyVGVtcGxhdGV9XG4gICAgICovXG4gICAgcmVuZGVyKGRvbW5vZGUpIHtcbiAgICAgICAgbGV0IG91dCA9IFwidmFyIF9fZGVidWdfcGF0aF9fID0gJyhyb290KSc7XCI7XG4gICAgICAgIG91dCArPSBcIlxcbnZhciBfZSA9IFtkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKV07XCI7XG5cblxuICAgICAgICBpZiAoZG9tbm9kZSBpbnN0YW5jZW9mIEhUTUxUZW1wbGF0ZUVsZW1lbnQpIHtcblxuICAgICAgICAgICAgZm9yIChsZXQgY3VyQ2hpbGQgb2YgZG9tbm9kZS5jb250ZW50LmNoaWxkTm9kZXMpIHtcbiAgICAgICAgICAgICAgICBvdXQgKz0gdGhpcy5fcmVuZGVyKGN1ckNoaWxkLCAgXCIocm9vdClcIiwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvdXQgKz0gdGhpcy5fcmVuZGVyKGRvbW5vZGUsICBcIihyb290KVwiLCAxKTtcbiAgICAgICAgfVxuXG5cbiAgICAgICAgbGV0IHhvdXQgPSBgXG4gICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKHNjb3BlKXtcbiAgICAgICAgICAgICAgICBsZXQgZm5zID0gW107XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgJHtvdXR9XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyAnRXJyb3IgaW4gJyArIF9fZGVidWdfcGF0aF9fICsgJzogJyArIGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBfZVswXTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIGA7XG5cbiAgICAgICAgY29uc29sZS5sb2coeG91dCk7XG4gICAgICAgIGxldCBmbiA7XG4gICAgICAgIGV2YWwoeG91dCk7XG4gICAgICAgIHJldHVybiBuZXcgS2FzaW1pclRlbXBsYXRlKGZuKTtcbiAgICB9XG5cbn1cblxuIiwiY2xhc3MgS2FzaW1pclRlbXBsYXRlIHtcblxuICAgIGNvbnN0cnVjdG9yKHRwbEZuKSB7XG4gICAgICAgIHRoaXMuX3RwbEZuID0gdHBsRm47XG4gICAgICAgIC8qKlxuICAgICAgICAgKlxuICAgICAgICAgKiBAdHlwZSB7SFRNTEVsZW1lbnR9XG4gICAgICAgICAqIEBwcml2YXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9iaW5kID0gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkb21TZWxlY3RvciB7c3RyaW5nfEhUTUxFbGVtZW50fVxuICAgICAqIEByZXR1cm4gS2FzaW1pclRlbXBsYXRlXG4gICAgICovXG4gICAgcmVuZGVySW4oZG9tU2VsZWN0b3IpIHtcbiAgICAgICAgbGV0IG5vZGUgPSBudWxsO1xuICAgICAgICBpZiAodHlwZW9mIGRvbVNlbGVjdG9yID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBub2RlID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihkb21TZWxlY3Rvcik7XG4gICAgICAgICAgICBpZiAobm9kZSA9PT0gbnVsbClcbiAgICAgICAgICAgICAgICB0aHJvdyBcImJpbmQoKTogY2FuJ3QgZmluZCBlbGVtZW50ICdcIiArIGRvbVNlbGVjdG9yICsgXCInXCI7XG4gICAgICAgIH0gZWxzZSBpZiAoZG9tU2VsZWN0b3IgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgbm9kZSA9IGRvbVNlbGVjdG9yO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgXCJiaW5kKCk6IHBhcmFtZXRlcjEgaXMgbm90IGEgSHRtbEVsZW1lbnRcIjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9iaW5kID0gbm9kZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqIEByZXR1cm4ge0thc2ltaXJUZW1wbGF0ZX1cbiAgICAgKi9cbiAgICByZW5kZXIoc2NvcGUpIHtcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5fdHBsRm4oc2NvcGUpKTtcbiAgICAgICAgdGhpcy5fYmluZC5yZXBsYWNlQ2hpbGQodGhpcy5fdHBsRm4oc2NvcGUpLCB0aGlzLl9iaW5kLmZpcnN0Q2hpbGQpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBzY29wZVxuICAgICAqIEByZXR1cm4ge0thc2ltaXJUZW1wbGF0ZX1cbiAgICAgKi9cbiAgICBvYnNlcnZlKHNjb3BlKSB7XG4gICAgICAgIHRoaXMucmVuZGVyKHNjb3BlKTtcbiAgICAgICAgd2luZG93LnNldEludGVydmFsKGUgPT4ge1xuICAgICAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KHNjb3BlKSAhPT0gdGhpcy5fb2JzZXJ2ZWRMYXN0VmFsdWUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9vYnNlcnZlZExhc3RWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KHNjb3BlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcihzY29wZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIDIwMCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxufVxuXG4iLCJcblxuXG5jbGFzcyBLbVRwbEVsZW0gZXh0ZW5kcyBIVE1MRWxlbWVudCB7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLl9hdHRycyA9IHtcbiAgICAgICAgICAgIGJpbmQ6IG51bGwsXG4gICAgICAgICAgICBvYnNlcnZlOiBudWxsLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLl9jb25maWcgPSB7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqXG4gICAgICAgICAqIEB0eXBlIHtLYXNpbWlyVGVtcGxhdGV9XG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnRwbCA9IG51bGw7XG4gICAgfVxuXG5cbiAgICBzdGF0aWMgZ2V0IG9ic2VydmVkQXR0cmlidXRlcygpIHsgcmV0dXJuIFtcImJpbmRcIiwgXCJvYnNlcnZlXCJdOyB9XG5cbiAgICBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7XG4gICAgICAgIHRoaXMuX2F0dHJzW25hbWVdID0gbmV3VmFsdWU7XG4gICAgfVxuXG4gICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7XG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibG9hZFwiLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImxvYWRcIiwgd2luZG93W1wiZGF0YVwiXSk7XG4gICAgICAgICAgICBsZXQgdGVtcGxhdGUgPSB0aGlzLnF1ZXJ5U2VsZWN0b3IoXCJ0ZW1wbGF0ZVwiKTtcbiAgICAgICAgICAgIGlmICh0ZW1wbGF0ZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCI8a20tdHBsPiBoYXMgbm8gdGVtcGxhdGUgY2hpbGQuXCIsIHRoaXMpO1xuICAgICAgICAgICAgICAgIHRocm93IFwiPGttLXRwbD4gcmVxdWlyZXMgPHRlbXBsYXRlPiBjaGlsZC5cIjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy50cGwgPSBrYXNpbWlyX3RwbCh0ZW1wbGF0ZSk7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNoaWxkKHRlbXBsYXRlKTtcbiAgICAgICAgICAgIHRoaXMudHBsLnJlbmRlckluKHRoaXMpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5fYXR0cnMuYmluZCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHRoaXMudHBsLmJpbmQod2luZG93W3RoaXMuX2F0dHJzLmJpbmRdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0aGlzLl9hdHRycy5vYnNlcnZlKSB7XG4gICAgICAgICAgICAgICAgbGV0IG9ic2VydmVkID0gd2luZG93W3RoaXMuX2F0dHJzLm9ic2VydmVdO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG9ic2VydmVkKTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9ic2VydmVkICE9PSBcIm9iamVjdFwiKVxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBcIm9ic2VydmVkIHZhcmlhYmxlIHdpbmRvd1snXCIgKyB0aGlzLl9hdHRycy5vYnNlcnZlICsgXCInXSBpcyB0eXBlb2YgXCIgKyAodHlwZW9mIG9ic2VydmVkKSArIFwiIGJ1dCBvYmplY3QgcmVxdWlyZWRcIjtcbiAgICAgICAgICAgICAgICB0aGlzLnRwbC5vYnNlcnZlKG9ic2VydmVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZGlzY29ubmVjdENhbGxiYWNrKCkge1xuXG4gICAgfVxuXG59XG5cbmN1c3RvbUVsZW1lbnRzLmRlZmluZShcImttLXRwbFwiLCBLbVRwbEVsZW0pO1xuXG4iXX0=

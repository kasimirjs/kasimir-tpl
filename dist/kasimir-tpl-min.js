/**
 * Infracamp's Kasimir Templates
 *
 * A no-dependency render on request
 *
 * @author Matthias Leuffen <m@tth.es>
 */
class KT_Renderable extends HTMLElement{constructor(){super(),this.state={origNode:null}}renderRecursive(e,t){if(e.hasChildNodes())for(let i of e.childNodes)"function"!=typeof i.render?this.renderRecursive(i,t):i.render(t)}initRecursive(e){void 0===e&&(e=this),"function"==typeof e.onKtInit&&e.onKtInit();for(let t of e.childNodes)this.initRecursive(t);"function"==typeof e.onAfterKtInit&&e.onAfterKtInit()}}var KT_DATA=[];class KT_Template extends KT_Renderable{constructor(){super(),this.isRendered=!1}render(e){!1===this.isRendered&&(this.appendChild(this.state.origNode.cloneNode(!0)),this.isRendered=!0);for(let t=0;t<this.state.parentTpls.length;t++)this.state.parentTpls[t].render(e);console.log("Dump from tpl: ",this.dump())}mount(e){return this}}customElements.define("x-kt-template",KT_Template);class KT_ForDirective extends KT_Renderable{constructor(){super(),this.state.len=0}onKtInit(){}onAfterKtInit(){console.log("onKtInit()",this.outerHTML);let e=this.firstElementChild;if(!e instanceof KT_ForElement||"object"!=typeof e)throw console.error("Element child of x-kt-for must be x-kt-block in",this.outerHTML),"Element chilf of x-kt-for must be x-kt-block.";this.hasAttribute("kt-id")||this.setAttribute("kt-id",KT_DATA.length),KT_DATA.push({origNode:e});for(let e=0;e<this.children.length;e++)this.removeChild(this.children.item(0))}connectedCallback(){}disconnectedCallback(){console.log("disconnected",this.outerHTML)}render(e){let t=parseInt(this.getAttribute("kt-id")),i=new RegExp("let (\\w+) of ([a-zA-Z0-9_.]+)"),s=(i=i.exec(this.getAttribute("for")))[2],n=i[1],r=e[s];for(let e=this.state.len;e<r.length;e++){let e=KT_DATA[t].origNode.cloneNode(!0);this.append(e),this.state.len++}for(let t=0;t<r.length;t++){e[n]=r[t],e.idx=t;let i=this.children.item(t);this.renderRecursive(i,e)}for(let e=this.state.len;e>r.length;e--)this.removeChild(this.lastElementChild),this.state.len--}}customElements.define("x-kt-for",KT_ForDirective);class KT_ForElement extends KT_Renderable{constructor(){super(),this.state.elements=[]}conntectedCallback(){}}customElements.define("x-kt-block",KT_ForElement);class KtIf extends KT_Renderable{onAfterKtInit(){console.log("onKtInit()",this.outerHTML);let e=this.firstElementChild;if(!e instanceof KT_ForElement||"object"!=typeof e)throw console.error("Element child of x-kt-for must be x-kt-block in",this.outerHTML),"Element chilf of x-kt-for must be x-kt-block.";this.hasAttribute("kt-id")||this.setAttribute("kt-id",KT_DATA.length),KT_DATA.push({origNode:e});for(let e=0;e<this.children.length;e++)this.removeChild(this.children.item(0))}render(scope){let stmt=this.getAttribute("stmt"),show=eval(stmt);if(show&&(0===this.children.length&&this.appendChild(KT_DATA[this.getAttribute("kt-id")].origNode.cloneNode(!0)),this.renderRecursive(this.children.item(0),scope)),!show&&this.hasChildNodes())for(let e=0;e<this.children.length;e++)this.renderRecursive(this.children.item(0))}}customElements.define("x-kt-if",KtIf);class KTVal extends HTMLElement{render(e){let t=this.getAttribute("select");this.innerText=e[t]}}customElements.define("x-kt-val",KTVal);class Renderer{constructor(){this.directives=[KT_ForDirective]}_parse(e,t){let i=null,s=null;if(console.log("run",e),e.hasAttribute("ngFor")){s=e,e=e.cloneNode(!0),(i=new KT_ForDirective).state.ngFor=e.getAttribute("ngFor");let n=new KT_ForElement;n.state.origNode=e,i.state.origNode=n,t.state.parentTpls.push(i),t=n}for(let i=0;i<e.children.length;i++)this._parse(e.children.item(i),t);null===i||s.replaceWith(i)}getTemplate(e){let t=new KT_Template;if(e instanceof HTMLTemplateElement){let i=e.content.children.item(0);console.log("Template start",i),e.parentElement.ownerDocument.adoptNode(i),t.state.origNode=i.cloneNode(!0),e.parentElement.appendChild(t),this._parse(i,t)}else t.state.origNode=e,this._parse(e,t);return t}}
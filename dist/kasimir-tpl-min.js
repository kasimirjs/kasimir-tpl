/**
 * Infracamp's Kasimir Templates
 *
 * A no-dependency render on request
 *
 * @see https://infracamp.org/project/kasimir
 * @author Matthias Leuffen <m@tth.es>
 */
class KtHelper{keval(stmt,c,e){try{let $=c;return eval(stmt)}catch(t){throw console.warn("cannot eval() stmt: '"+stmt+"' on element ",e.outerHTML,"(context:",c,")"),"eval('"+stmt+"') failed: "+t}}scopeEval($scope,selector){const reserved=["var","null","let","const","function","class","in","of","for","true","false"];let r="";for(let t in $scope)-1===reserved.indexOf(t)&&(r+=`var ${t} = $scope['${t}'];`);var __val=null;let s=`__val = ${selector};`;try{eval(r+s)}catch(t){throw console.error(`scopeEval('${r}${s}') failed: ${t}`),`eval('${s}') failed: ${t}`}return __val}unindentText(t){let e=t.match(/\n(\s*)/m)[1];return t=(t=t.replace(new RegExp(`\n${e}`,"g"),"\n")).trim()}}var _KT_ELEMENT_ID=0;class KtRenderable extends HTMLTemplateElement{constructor(){super(),this._hlpr=new KtHelper,this._els=null,this._attrs={debug:!1},this._ktId=++_KT_ELEMENT_ID}attributeChangedCallback(t,e,s){this._attrs[t]=s}_log(t,e,s){let n=[this.constructor.name+"#"+this.id+"["+this._ktId+"]:"];for(let t of arguments)n.push(t);!1!==this._attrs.debug&&console.log.apply(this,n)}renderRecursive(t,e){if(!t.hasOwnProperty("_kaMb")||t._kaMb===this._ktId)if("function"!=typeof t.render)for(let s of t.childNodes){if(!0===t.ktSkipRender)return;this.renderRecursive(s,e)}else t.render(e)}_removeNodes(){if(null!==this._els){for(let t of this._els)"function"==typeof t._removeNodes&&t._removeNodes(),null!==this.parentElement&&this.parentElement.removeChild(t);this._els=null}}_appendElementsToParent(t){void 0===t&&(t=this.nextSibling);let e=this.content.cloneNode(!0);this._els=[];for(let t of e.children)t._kaMb=this._ktId,this._els.push(t);this.parentElement.insertBefore(e,t)}}class KtTemplateParser{_parseTextNode(t,e){let s=t.split(/(\{\{|\}\})/);for(;s.length>0&&(e.appendChild(new Text(s.shift())),0!==s.length);){s.shift();let t=new KaVal;t.setAttribute("stmt",s.shift().trim()),s.shift(),e.appendChild(t)}}parseRecursive(t){if(t instanceof DocumentFragment){for(let e of t.children)this.parseRecursive(e);return}if("function"!=typeof t.getAttribute)return;if(!0===t.ktParsed)return;t.ktParsed=!0;for(let e of t.childNodes){if(void 0===e.data)continue;let t=new DocumentFragment;this._parseTextNode(e.data,t),e.replaceWith(t)}if(t.hasAttribute("*for")){let e=document.createElement("template",{is:"ka-loop"}),s=t.getAttribute("*for"),n=t.cloneNode(!0);e.content.appendChild(n);let i=s.match(/let\s+(\S*)\s+(in|of|repeat)\s+(\S*)(\s+indexby\s+(\S*))?/);if(null===i)throw"Cannot parse *for='"+s+"' for element "+t.outerHTML;e.setAttribute("formode",i[2]),e.setAttribute("forselect",i[3]),e.setAttribute("fordata",i[1]),void 0!==i[5]&&e.setAttribute("foridx",i[5]),t.replaceWith(e),t=n}if(t.hasAttribute("*if")){let e=document.createElement("template",{is:"kt-if"}),s=t.getAttribute("*if"),n=t.cloneNode(!0);e.content.appendChild(n),e.setAttribute("stmt",s),t.replaceWith(e),t=n}let e=[],s=[],n=new RegExp("^\\[(.+)\\]$");for(let i of t.getAttributeNames()){let r=n.exec(i);if(null===r)continue;let l=r[1].split(".");if(1===l.length)s.push(`'${l[0]}': `+t.getAttribute(i));else switch(l[0]){case"classlist":e.push(`'${l[1]}': `+t.getAttribute(i));break;default:console.warn("Invalid attribute '"+i+"'")}}if(s.length>0||e.length>0){let n=document.createElement("template",{is:"kt-maintain"}),i=t.cloneNode(!0);n.content.appendChild(i),s.length>0&&i.setAttribute("kt-attrs","{"+s.join(",")+"}"),e.length>0&&i.setAttribute("kt-classes","{"+e.join(",")+"}"),t.replaceWith(n),t=i}for(let e of t.children)this.parseRecursive(e)}}function ka_tpl(t){if(t instanceof KaTpl)return t;let e=document.getElementById(t);if(e instanceof KaTpl)return e;throw`Selector '${t}' is not a <template is="ka-tpl"> element`}var KT_FN={"kt-classes":function(t,e,s){"use strict";let n=(new KtHelper).scopeEval(s,e);for(let e in n)n.hasOwnProperty(e)&&(!0===n[e]?t.classList.add(e):t.classList.remove(e))},"kt-attrs":function(t,e,s){let n=(new KtHelper).scopeEval(s,e);for(let e in n)n.hasOwnProperty(e)&&(null!==n[e]?t.setAttribute(e,n[e]):t.setAttribute(e,""))}};class KaInclude extends KtRenderable{constructor(){super(),this.elements=null,this._attrs={src:null,auto:null,raw:null}}static get observedAttributes(){return["src"]}_importScritpRecursive(t){let e=t instanceof HTMLTemplateElement?t.content.childNodes:t.childNodes;for(let t of e){if("SCRIPT"!==t.tagName){this._importScritpRecursive(t);continue}let e=document.createElement("script");e.innerHTML=t.innerHTML,t.replaceWith(e)}}_loadDataRemote(){let t=new XMLHttpRequest;t.open("GET",this._attrs.src),t.onreadystatechange=(()=>{if(4!==t.readyState);else{if(t.status>=400)return void console.warn("Can't load '"+this.params.src+"': "+t.responseText);if(this.innerHTML=t.responseText,null!==this._attrs.raw){(new KtTemplateParser).parseRecursive(this.content)}this._importScritpRecursive(this.content),this._appendElementsToParent();for(let t of this._els)this._log("trigger DOMContentLoaded event on",t),t.dispatchEvent(new Event("DOMContentLoaded"))}}),t.send()}disconnectedCallback(){for(let t of this._els)this.parentElement.removeChild(t)}connectedCallback(){null!==this.getAttribute("auto")&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this._loadDataRemote()}):this._loadDataRemote())}render(t){null===this._els&&this._appendElementsToParent()}}customElements.define("ka-include",KaInclude,{extends:"template"});class KaLoop extends KtRenderable{constructor(){super(),this._origSibling=!1,this._attrs={forselect:null,formode:null,foridx:null,fordata:null,foreval:null},this._els=[]}static get observedAttributes(){return["forselect","foridx","fordata","foreval","formode"]}_appendElem(){let t=this.content.cloneNode(!0),e=[];for(let s of t.children)s._kaMb=this._ktId,e.push(s);for(let t=0;t<e.length;t++)this.parentElement.insertBefore(e[t],this._origSibling);this._els.push({node:e})}_maintainNode(t,e){this._els.length<t+1&&this._appendElem(),null!==this._attrs.foridx&&(e[this._attrs.foridx]=t),null!==this._attrs.foreval&&this._hlpr.keval(this._attrs.foreval,e,this);for(let s of this._els[t].node)this.renderRecursive(s,e)}render(t){let e=this._attrs.forselect,s=this._hlpr.scopeEval(t,e);if("object"!=typeof s)throw console.warn(`Invalid forSelect="${e}" returned:`,select,"on context",context,"(Element: ",this.outerHTML,")"),"Invalid forSelect selector. see waring.";!1===this._origSibling&&(this._origSibling=this.nextSibling);let n=0;switch(this._attrs.formode){case"in":for(n in s)t[this._attrs.fordata]=n,this._maintainNode(n,t);break;case"of":n=0;for(let e of s)t[this._attrs.fordata]=e,this._maintainNode(n,t),n++;break;case"repeat":for(n=0;n<s;n++)t[this._attrs.fordata]=n,this._maintainNode(n,t),n++;break;default:throw"Invalid for type '"+this._attrs.formode+"' in ".this.outerHTML}for(let t=n;s.length<this._els.length;t++){let t=this._els.pop();for(let e of t.node)"function"==typeof e._removeNodes&&e._removeNodes(),this.parentElement.removeChild(e)}}}customElements.define("ka-loop",KaLoop,{extends:"template"});var KASELF=null;class KaTpl extends KtRenderable{constructor(){super(),this._attrs={debug:!1,stmt:null,afterrender:null},this._isInitializing=!1,this._isRendering=!1,this._scope={}}static get observedAttributes(){return["stmt","debug"]}disconnectedCallback(){for(let t of this._els)this.parentElement.removeChild(t)}connectedCallback(){this._log("connectedCallback()",this);let auto=this.getAttribute("auto");if(null!==auto){this._log("autostart: _init()","document.readyState: ",document.readyState);let init=()=>{this._init(),""===auto?this.render(this._scope):eval(auto)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{init()}):init()}}set $scope(t){this._scope=t,this._isInitializing||this.render(this._scope)}get $scope(){let t={set:(t,e,s,n)=>(t[e]=s,this._isRendering||this.render(this.$scope),!0),get:(e,s)=>"object"==typeof e[s]?new Proxy(e[s],t):e[s]};return new Proxy(this._scope,t)}_init(){if(null!==this._els)return;this._isInitializing=!0,null!==this.nextElementSibling&&this.nextElementSibling.hasAttribute("ka-loader")&&this.parentElement.removeChild(this.nextElementSibling);this.nextSibling;(new KtTemplateParser).parseRecursive(this.content),KASELF=this,null===this._els&&this._appendElementsToParent(),this._isInitializing=!1}render(t){this._log("render($scope= ",t,")"),this._init(),this._isRendering=!0;for(let e of this._els)this.renderRecursive(e,t);this._isRendering=!1}}customElements.define("ka-tpl",KaTpl,{extends:"template"});class KaVal extends HTMLElement{constructor(){super(),this._ktHlpr=new KtHelper,this._attrs={debug:!1,stmt:null,afterrender:null}}static get observedAttributes(){return["stmt","afterrender","debug"]}attributeChangedCallback(t,e,s){this._attrs[t]=s}connectedCallback(){this.hasAttribute("auto")&&this.render({})}_log(){!1!==this._attrs.debug&&console.log.apply(this,arguments)}render($scope){this._log("render(",$scope,`) on '${this.outerHTML}'`);try{let v=this._ktHlpr.scopeEval($scope,this._attrs.stmt);"object"==typeof v&&(v=JSON.stringify(v)),this.hasAttribute("unindent")&&(v=this._ktHlpr.unindentText(v)),this.hasAttribute("html")?this.innerHTML=v:this.innerText=v,null!==this._attrs.afterrender&&eval(this._attrs.afterrender)}catch(t){this.innerText=t}}}customElements.define("ka-val",KaVal);class KtIf extends KtRenderable{constructor(){super(),this._attrs={stmt:null}}static get observedAttributes(){return["stmt"]}render(t){if(this._hlpr.scopeEval(t,this._attrs.stmt)){null===this._els&&this._appendElementsToParent();for(let e of this._els)this.renderRecursive(e,t)}else this._removeNodes()}}customElements.define("kt-if",KtIf,{extends:"template"});class KtMaintain extends KtRenderable{constructor(){super(),this._attrs={stmt:null,debug:!1}}static get observedAttributes(){return["stmt","debug"]}disconnectedCallback(){this._removeNodes()}render(t){null===this._els&&this._appendElementsToParent();for(let e of this._els)if("function"==typeof e.hasAttribute){for(let s in KT_FN)e.hasAttribute(s)&&KT_FN[s](e,e.getAttribute(s),t);this.renderRecursive(e,t,!0)}}}customElements.define("kt-maintain",KtMaintain,{extends:"template"});
/**
 * Infracamp's Kasimir Templates
 *
 * A no-dependency render on request
 *
 * @author Matthias Leuffen <m@tth.es>
 */
class KT_Renderable extends HTMLElement{constructor(){super(),this.state={origNode:null}}renderRecursive(e,t){if(e.hasChildNodes())for(let s of e.childNodes)"function"!=typeof s.render?this.renderRecursive(s,t):(console.log("render",s),s.render(t))}initRecursive(e){void 0===e&&(e=this),"function"==typeof e.onKtInit&&e.onKtInit();for(let t of e.childNodes)this.initRecursive(t);"function"==typeof e.onAfterKtInit&&e.onAfterKtInit()}}var KT_FN={"[class]":function(elem,val,scope){"use strict";try{var classes=null;let e="classes = "+val,ret=eval(e);console.log("eval",e,"ret: ",ret,"classes:",classes)}catch(e){throw e+" in [data] of "+elem.outerHTML}for(let e in classes)classes.hasOwnProperty(e)&&(!0===classes[e]?elem.classList.add(e):elem.classList.remove(e))}},KT_DATA=[];class KT_Template extends KT_Renderable{constructor(){super(),this.isRendered=!1}render(e){!1===this.isRendered&&(this.appendChild(this.state.origNode.cloneNode(!0)),this.isRendered=!0);for(let t=0;t<this.state.parentTpls.length;t++)this.state.parentTpls[t].render(e);console.log("Dump from tpl: ",this.dump())}mount(e){return this}}customElements.define("x-kt-template",KT_Template);class KT_ForDirective extends KT_Renderable{constructor(){super(),this.state.len=0}onKtInit(){}onAfterKtInit(){console.log("onKtInit()",this.outerHTML);let e=this.firstElementChild;if(!e instanceof KtBlock||"object"!=typeof e)throw console.error("Element child of x-kt-for must be x-kt-block in",this.outerHTML),"Element chilf of x-kt-for must be x-kt-block.";this.hasAttribute("kt-id")||this.setAttribute("kt-id",KT_DATA.length),KT_DATA.push({origNode:e});for(let e=0;e<this.children.length;e++)this.removeChild(this.children.item(0))}connectedCallback(){}disconnectedCallback(){console.log("disconnected",this.outerHTML)}render(e){let t=parseInt(this.getAttribute("kt-id")),s=new RegExp("let (\\w+) of ([a-zA-Z0-9_.]+)"),i=(s=s.exec(this.getAttribute("for")))[2],l=s[1],o=e[i];for(let e=this.state.len;e<o.length;e++){let e=KT_DATA[t].origNode.cloneNode(!0);this.append(e),this.state.len++}for(let t=0;t<o.length;t++){e[l]=o[t],e.idx=t,this.children.item(t).render(e)}for(let e=this.state.len;e>o.length;e--)this.removeChild(this.lastElementChild),this.state.len--}}customElements.define("x-kt-for",KT_ForDirective);class KtBlock extends KT_Renderable{constructor(){super(),this.state.elements=[]}conntectedCallback(){}applyLogic(e,t){for(let s of e.getAttributeNames()){if(void 0===KT_FN[s])continue;(0,KT_FN[s])(e,e.getAttribute(s),t)}}render(e){console.log("apply logic");for(let t of this.children)this.applyLogic(t,e),this.renderRecursive(t,e)}}customElements.define("x-kt-block",KtBlock);class KtIf extends KT_Renderable{onAfterKtInit(){console.log("onKtInit()",this.outerHTML);let e=this.firstElementChild;if(!e instanceof KtBlock||"object"!=typeof e)throw console.error("Element child of x-kt-for must be x-kt-block in",this.outerHTML),"Element chilf of x-kt-for must be x-kt-block.";this.hasAttribute("kt-id")||this.setAttribute("kt-id",KT_DATA.length),KT_DATA.push({origNode:e});for(let e=0;e<this.children.length;e++)this.removeChild(this.children.item(0))}render(scope){let stmt=this.getAttribute("stmt"),show=eval(stmt);if(show&&(0===this.children.length&&this.appendChild(KT_DATA[this.getAttribute("kt-id")].origNode.cloneNode(!0)),this.renderRecursive(this.children.item(0),scope)),!show&&this.hasChildNodes())for(let e=0;e<this.children.length;e++)this.renderRecursive(this.children.item(0))}}customElements.define("x-kt-if",KtIf);class KTVal extends HTMLElement{render(e){let t=this.getAttribute("select");this.innerText=e[t]}}customElements.define("x-kt-val",KTVal);class Renderer{constructor(){this.directives=[KT_ForDirective]}_parse(e,t){let s=null,i=null;if(console.log("run",e),e.hasAttribute("ngFor")){i=e,e=e.cloneNode(!0),(s=new KT_ForDirective).state.ngFor=e.getAttribute("ngFor");let l=new KT_ForElement;l.state.origNode=e,s.state.origNode=l,t.state.parentTpls.push(s),t=l}for(let s=0;s<e.children.length;s++)this._parse(e.children.item(s),t);null===s||i.replaceWith(s)}getTemplate(e){let t=new KT_Template;if(e instanceof HTMLTemplateElement){let s=e.content.children.item(0);console.log("Template start",s),e.parentElement.ownerDocument.adoptNode(s),t.state.origNode=s.cloneNode(!0),e.parentElement.appendChild(t),this._parse(s,t)}else t.state.origNode=e,this._parse(e,t);return t}}
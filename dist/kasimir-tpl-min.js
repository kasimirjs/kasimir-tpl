/**
 * Infracamp's Kasimir Templates
 *
 * A no-dependency render on request
 *
 * @author Matthias Leuffen <m@tth.es>
 */
class KtRenderable extends HTMLTemplateElement{renderRecursive(e,t,s){if("function"!=typeof e.render){if(!e.hasOwnProperty("ktOwner")||!0===s)for(let s of e.childNodes){if(!0===e.ktSkipRender)return;this.renderRecursive(s,t)}}else e.render(t)}}function kt_tpl(e){if(e instanceof KtTpl)return e;let t=document.getElementById(e);if(t instanceof KtTpl)return t;throw`Selector '${e}' is not a <kt-tpl> element`}var KT_FN={"kt-classes":function(elem,val,scope){"use strict";try{var classes=null;let e="classes = "+val,ret=eval(e)}catch(e){throw e+" in [data] of "+elem.outerHTML}for(let e in classes)classes.hasOwnProperty(e)&&(!0===classes[e]?elem.classList.add(e):elem.classList.remove(e))},"kt-attrs":function(elem,val,scope){try{var classes=null;let e="classes = "+val,ret=eval(e)}catch(e){throw e+" in *attrs of "+elem.outerHTML}for(let e in classes)classes.hasOwnProperty(e)&&(null!==classes[e]?elem.setAttribute(e,classes[e]):elem.setAttribute(e,""))}};class KtFor extends KtRenderable{constructor(){super(),this.elements=[],this.params={forselect:null,foridx:"idx",foreval:null}}static get observedAttributes(){return["forselect","foridx","foreval"]}attributeChangedCallback(e,t,s){this.params[e]=s}render(context){let select=context[this.params.forselect];if("object"!=typeof select)throw console.warn(`Invalid forSelect="${this.params.forselect}" returned:`,select,"on context",context,"(Element: ",this.outerHTML,")"),"Invalid forSelect selector. see waring.";for(let e=this.elements.length;e<select.length;e++){let e=this.content.cloneNode(!0),t=[];for(let s of e.children)s.ktOwner="for",t.push(s);for(let e=t.length-1;e>=0;e--)this.parentElement.insertBefore(t[e],this.nextSibling);this.elements.unshift({node:t})}for(let idx=0;idx<select.length;idx++){context[this.params.foridx]=idx,context.self=select[idx],null!==this.params.foreval&&eval(this.params.foreval);for(let e of this.elements[idx].node)this.renderRecursive(e,context,!0)}for(let e=this.elements.length;select.length<this.elements.length;e++){let e=this.elements.pop();for(let t of e.node)this.parentElement.removeChild(t)}}}customElements.define("kt-for",KtFor,{extends:"template"});class KtIf extends KtRenderable{constructor(){super(),this.elements=null,this.params={stmt:null}}static get observedAttributes(){return["stmt"]}attributeChangedCallback(e,t,s){this.params[e]=s}render(context){let stmt=this.params.stmt,isTrue=eval(stmt);if(isTrue){if(null!==this.elements){for(let e of this.elements)this.renderRecursive(e,context,!0);return}let e=this.content.cloneNode(!0);this.elements=[];for(let t of e.childNodes)t.ktOwner="if",this.elements.push(t);for(let e=this.elements.length-1;e>=0;e--)this.parentElement.insertBefore(this.elements[e],this.nextSibling);for(let e of this.elements)this.renderRecursive(e,context,!0)}else{if(null===this.elements)return;for(let e of this.elements)this.parentElement.removeChild(e);this.elements=null}}}customElements.define("kt-if",KtIf,{extends:"template"});class KtInclude extends KtRenderable{constructor(){super(),this.elements=null,this.params={src:null}}static get observedAttributes(){return["src"]}attributeChangedCallback(e,t,s){this.params[e]=s}loadRemote(){}_appendChildFromContent(){if(null!==this.elements)return;let e=this.content.cloneNode(!0);this.elements=[];for(let t of e.childNodes)t.ktOwner="include",this.elements.push(t);for(let e=this.elements.length-1;e>=0;e--)this.parentElement.insertBefore(this.elements[e],this.nextSibling)}_renderElements(){for(let e of this.elements)this.renderRecursive(e,context,!0)}loadDataRemote(){let e=new XMLHttpRequest;e.open("GET",this.params.src),e.onreadystatechange=(()=>{if(4===e.readyState){if(e.status>=400)return void console.warn("Can't load '"+this.params.src+"': "+e.responseText);return this.innerHTML=e.responseText,(new KtTemplateParser).parseRecursive(this.content),this._appendChildFromContent(),void this._renderElements()}}),e.send()}render(e){null===this.elements?this.loadDataRemote():this._renderElements()}}customElements.define("kt-include",KtInclude,{extends:"template"});class KtMaintain extends KtRenderable{constructor(){super(),this.elements=null,this.params={stmt:null}}static get observedAttributes(){return["stmt"]}attributeChangedCallback(e,t,s){this.params[e]=s}render(e){if(null===this.elements){let e=this.content.cloneNode(!0);this.elements=[];for(let t of e.childNodes)t.ktOwner="maintain",this.elements.push(t);for(let e=this.elements.length-1;e>=0;e--)this.parentElement.insertBefore(this.elements[e],this.nextSibling)}for(let t of this.elements)if("function"==typeof t.hasAttribute){for(let s in KT_FN)t.hasAttribute(s)&&KT_FN[s](t,t.getAttribute(s),e);this.renderRecursive(t,e,!0)}}}customElements.define("kt-maintain",KtMaintain,{extends:"template"});class KtTpl extends HTMLElement{constructor(){super(),this.elements=[],this.params={stmt:null}}renderRecursive(e,t){if("function"!=typeof e.render){if(!e.hasOwnProperty("ktOwner"))for(let s of e.childNodes)this.renderRecursive(s,t)}else e.render(t)}static get observedAttributes(){return["stmt"]}attributeChangedCallback(e,t,s){this.params[e]=s}render(e){for(let t of this.childNodes)this.renderRecursive(t,e)}}customElements.define("kt-tpl",KtTpl);class KtVal extends HTMLElement{constructor(){super(),this.elements=[],this.params={stmt:null}}static get observedAttributes(){return["stmt"]}attributeChangedCallback(e,t,s){this.params[e]=s}render(context){this.innerText=JSON.stringify(eval(this.params.stmt))}}customElements.define("kt-val",KtVal);class KtTemplateParser{parseRecursive(e){if("function"!=typeof e.getAttribute)return;if(e.hasAttribute("*for")){let t=document.createElement("template",{is:"kt-for"}),s=e.getAttribute("*for"),n=e.cloneNode(!0);t.content.appendChild(n),t.setAttribute("forselect",s),e.replaceWith(t),e=n}if(e.hasAttribute("*if")){let t=document.createElement("template",{is:"kt-if"}),s=e.getAttribute("*if"),n=e.cloneNode(!0);t.content.appendChild(n),t.setAttribute("stmt",s),e.replaceWith(t),e=n}let t=[],s=[],n=new RegExp("^\\[(.+)\\]$");for(let l of e.getAttributeNames()){let r=n.exec(l);if(null===r)continue;let i=r[1].split(".");if(1===i.length)s.push(`'${i[0]}': `+e.getAttribute(l));else switch(i[0]){case"classlist":t.push(`'${i[1]}': `+e.getAttribute(l));break;default:console.warn("Invalid attribute '"+l+"'")}}if(s.length>0||t.length>0){let n=document.createElement("template",{is:"kt-maintain"}),l=e.cloneNode(!0);n.content.appendChild(l),s.length>0&&l.setAttribute("kt-attrs","{"+s.join(",")+"}"),t.length>0&&l.setAttribute("kt-classes","{"+t.join(",")+"}"),e.replaceWith(n),e=l}for(let t of e.children)this.parseRecursive(t)}}